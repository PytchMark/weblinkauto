<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carsales ¬∑ Admin Console</title>
  <meta name="description" content="Admin console for dealers, inventory, and requests." />

  <style>
    :root{
      --bg:#f6f7fb;
      --surface:#ffffff;
      --surface2:#fbfbfd;

      --ink:#0f172a;
      --muted:#64748b;
      --muted2:#94a3b8;

      --brand:#DC143C;
      --brand2:#E53935;
      --brandSoft:#FDECEA;
      --brandLine:rgba(220,38,38,.18);

      --line:#e5e7eb;
      --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      --shadow2: 0 10px 24px rgba(15, 23, 42, 0.08);

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --radius:18px;
      --radius2:24px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(circle at top left, rgba(220,38,38,.08), transparent 45%),
        radial-gradient(circle at bottom right, rgba(239,68,68,.06), transparent 55%),
        var(--bg);
      -webkit-font-smoothing:antialiased;
    }
    a{color:inherit;text-decoration:none}
    .hidden{display:none!important}

    .wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .shell{
      width:100%;
      max-width:1260px;
      background:rgba(255,255,255,.86);
      border-radius:var(--radius2);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      padding:18px;
      backdrop-filter: blur(12px);
    }

    .top{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .badge{
      width:44px;height:44px;border-radius:16px;
      background: radial-gradient(circle at 20% 20%, #fff, var(--brandSoft) 55%, rgba(220,38,38,.25));
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:18px;color:var(--brand);
      box-shadow: 0 12px 24px rgba(220,38,38,.14);
      overflow:hidden;
    }
    .badge img{width:100%;height:100%;object-fit:cover}
    .title{font-size:18px;font-weight:900}
    .sub{font-size:12px;color:var(--muted);margin-top:3px}

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .btn{
      border-radius:999px;
      border:1px solid transparent;
      padding:9px 14px;
      font-size:12px;
      font-weight:750;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      background:transparent;
      color:var(--ink);
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .btn-ghost{
      border:1px solid var(--line);
      background:rgba(255,255,255,.90);
      box-shadow:var(--shadow2);
    }
    .btn-ghost:hover{transform:translateY(-1px)}

    .btn-primary{
      background:linear-gradient(135deg, var(--brand2), var(--brand));
      color:#fff;
      box-shadow:0 16px 32px rgba(220,38,38,.28);
    }
    .btn-primary:hover{transform:translateY(-1px)}

    .btn-danger{
      border:1px solid rgba(239,68,68,.30);
      background:rgba(239,68,68,.08);
      color:#991b1b;
      box-shadow:var(--shadow2);
    }
    .btn-danger:hover{transform:translateY(-1px); background:rgba(239,68,68,.12)}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.90);
      border:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      box-shadow:var(--shadow2);
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:var(--warn);
      box-shadow:0 0 0 3px rgba(245,158,11,.18);
    }
    .dot.on{background:var(--ok); box-shadow:0 0 0 3px rgba(22,163,74,.18)}
    .dot.err{background:var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.18)}

    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:1020px){ .grid{grid-template-columns:0.36fr 0.64fr} }

    .panel{
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius:20px;
      padding:14px;
      box-shadow:var(--shadow2);
    }
    .panel h3{margin:0 0 6px;font-size:13px;font-weight:900;letter-spacing:.02em}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}

    .field{margin-top:10px}
    .label{display:flex;justify-content:space-between;gap:8px;font-size:11px;color:var(--muted);margin-bottom:5px}
    .input,.select,.textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      padding:10px 12px;
      font-size:13px;
      color:var(--ink);
      outline:none;
      transition:box-shadow .12s ease, border-color .12s ease;
    }
    .input:focus,.select:focus,.textarea:focus{
      border-color:rgba(220,38,38,.45);
      box-shadow:0 0 0 4px rgba(220,38,38,.12);
    }
    .textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr;gap:8px}
    @media(min-width:560px){.row.two{grid-template-columns:1fr 1fr}}

    .kpis{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:10px;
      margin-bottom:10px;
    }
    .kpi{
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.96);
      padding:12px;
      box-shadow:var(--shadow2);
    }
    .kpi .t{font-size:11px;color:var(--muted)}
    .kpi .v{font-size:18px;font-weight:900}
    .kpi .s{font-size:11px;color:var(--muted2)}

    .tabs{
      display:flex;gap:6px;flex-wrap:wrap;
      border-radius:999px;padding:4px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      box-shadow:var(--shadow2);
    }
    .tab{
      border:none;cursor:pointer;
      padding:7px 12px;border-radius:999px;
      background:transparent;color:var(--muted);
      font-size:11px;font-weight:900;letter-spacing:.05em;
      transition: background .12s ease, color .12s ease, transform .08s ease;
    }
    .tab.active{background:rgba(220,38,38,.10);color:var(--brand);transform:translateY(-1px)}

    .table-shell{
      overflow:hidden;border-radius:20px;border:1px solid var(--line);
      background:rgba(255,255,255,.96);box-shadow:var(--shadow2);
    }
    .table-head{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:12px 14px;border-bottom:1px solid var(--line);
      background:linear-gradient(to right, rgba(220,38,38,.05), rgba(255,255,255,.92));
    }
    .table-title{font-size:13px;font-weight:900}
    .table-meta{font-size:11px;color:var(--muted)}
    .scroll{max-height:620px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:12px}
    thead{position:sticky;top:0;background:var(--surface2);z-index:1}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--line)}
    th{font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)}
    tbody tr:hover{background:rgba(220,38,38,.04)}
    .mono{font-family:var(--mono); font-size:11px}

    .badgeMini{
      display:inline-flex;align-items:center;
      padding:3px 8px;border-radius:999px;
      font-size:10px;border:1px solid rgba(220,38,38,.22);
      background:rgba(220,38,38,.06);color:#991b1b;
    }

    .status{
      display:inline-flex;align-items:center;
      padding:3px 9px;border-radius:999px;
      font-size:10px;font-weight:900;letter-spacing:.08em;text-transform:uppercase;
      border:1px solid transparent;
    }
    .active{background:rgba(22,163,74,.10);color:#166534;border-color:rgba(22,163,74,.30)}
    .paused{background:rgba(245,158,11,.10);color:#92400e;border-color:rgba(245,158,11,.30)}

    /* Modal */
    .backdrop{
      position:fixed;inset:0;z-index:50;
      background:rgba(15,23,42,.55);
      backdrop-filter:blur(10px);
      display:none;align-items:center;justify-content:center;padding:16px;
    }
    .backdrop.show{display:flex}
    .modal{
      width:100%;max-width:820px;background:rgba(255,255,255,.98);
      border-radius:26px;border:1px solid var(--line);
      box-shadow:0 30px 70px rgba(15,23,42,.22);overflow:hidden;
    }
    .mhead{
      padding:14px 16px 10px;
      display:flex;justify-content:space-between;align-items:flex-start;gap:10px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(to right, rgba(220,38,38,.06), rgba(255,255,255,.94));
    }
    .mhead h3{margin:0;font-size:14px;font-weight:900}
    .xbtn{
      border:none;background:rgba(15,23,42,.04);
      color:var(--ink);font-size:20px;cursor:pointer;
      width:34px;height:34px;border-radius:999px;
    }
    .xbtn:hover{background:rgba(220,38,38,.10);color:var(--brand)}
    .mbody{padding:14px 16px}
    .statusline{min-height:18px;font-size:12px;color:var(--muted);margin-top:8px}
    .statusline.error{color:var(--bad)}

    #toast{
      position:fixed;bottom:16px;right:16px;z-index:60;
      padding:10px 14px;border-radius:999px;font-size:12px;
      display:none;align-items:center;gap:8px;
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
    }
    #toast.show{display:flex}
    #toast.success{border-color:rgba(22,163,74,.35);color:#166534}
    #toast.error{border-color:rgba(239,68,68,.35);color:#991b1b}
    #toastDot{width:8px;height:8px;border-radius:999px;background:var(--brand)}

    .splitBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- LOGIN -->
    <div class="shell" id="loginView">
      <div class="top">
        <div class="brand">
          <div class="badge"><img src="https://res.cloudinary.com/dd8pjjxsm/image/upload/v1770298701/ChatGPT_Image_Sep_6_2025_08_27_53_AM_raorxf.png" alt="Admin logo" /></div>
          <div>
            <div class="title">Admin Console</div>
            <div class="sub">Manage dealers, inventory, and viewing requests.</div>
          </div>
        </div>
        <div class="actions">
          <a class="btn btn-ghost" href="/storefront">‚Üê Storefront</a>
          <a class="btn btn-ghost" href="/dealer">Dealer ‚Üó</a>
        </div>
      </div>

      <div class="panel">
        <h3>Sign in</h3>
        <div class="hint">
          Login uses Cloud Run env vars:
          <span class="mono">ADMIN_USERNAME</span> /
          <span class="mono">ADMIN_PASSWORD</span>.
        </div>

        <div class="row two" style="margin-top:10px">
          <div class="field">
            <div class="label"><span>Username</span><span>Required</span></div>
            <input id="username" class="input" placeholder="admin" autocomplete="username" />
          </div>
          <div class="field">
            <div class="label"><span>Password</span><span>Required</span></div>
            <input id="password" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>
        </div>

        <div class="splitBtns">
          <button class="btn btn-ghost" id="btnDemo" type="button">Demo mode</button>
          <button class="btn btn-primary" id="btnLogin" type="button">Sign in</button>
        </div>

        <div class="statusline" id="loginStatus"></div>
      </div>
    </div>

    <!-- DASH -->
    <div class="shell hidden" id="dashView">
      <div class="top">
        <div class="brand">
          <div class="badge"><img src="https://res.cloudinary.com/dd8pjjxsm/image/upload/v1770298701/ChatGPT_Image_Sep_6_2025_08_27_53_AM_raorxf.png" alt="Admin logo" /></div>
          <div>
            <div class="title">Carsales Admin</div>
            <div class="sub" id="whoami">Admin</div>
          </div>
        </div>

        <div class="actions">
          <div class="pill" title="API health">
            <span class="dot" id="apiDot"></span>
            <span id="apiStatus">Connecting‚Ä¶</span>
          </div>

          <div class="tabs" role="tablist" aria-label="Admin tabs">
            <button class="tab active" id="tabDealers" data-tab="dealers" type="button">Dealers</button>
            <button class="tab" id="tabSummary" data-tab="summary" type="button">Summary</button>
            <button class="tab" id="tabInventory" data-tab="inventory" type="button">Inventory</button>
            <button class="tab" id="tabRequests" data-tab="requests" type="button">Requests</button>
            <button class="tab" id="tabSettings" data-tab="settings" type="button">Settings</button>
          </div>

          <button class="btn btn-ghost" id="btnRefresh" type="button">Refresh</button>
          <button class="btn btn-ghost" id="btnLogout" type="button">Logout</button>
        </div>
      </div>

      <div class="grid">
        <!-- LEFT -->
        <div class="panel">
          <h3>Controls</h3>
          <div class="hint" id="hint">Search + filter across the current tab.</div>

          <div class="field">
            <div class="label"><span>Search</span><span>Dealer / Vehicle / Customer</span></div>
            <input id="q" class="input" placeholder="Search‚Ä¶" />
          </div>

          <div class="field" id="statusFilterWrap">
            <div class="label"><span>Status filter</span><span>Contextual</span></div>
            <select id="statusFilter" class="select">
              <option value="">All</option>
            </select>
          </div>

          <!-- Summary controls -->
          <div class="panel hidden" id="summaryControls" style="margin-top:10px">
            <h3>Summary month</h3>
            <div class="hint">Loads KPIs for all dealers in one request.</div>
            <div class="field">
              <div class="label"><span>Month</span><span>YYYY-MM</span></div>
              <input id="summaryMonth" class="input" type="month" />
            </div>
            <div class="splitBtns">
              <button class="btn btn-primary" id="btnLoadSummary" type="button">Load summary</button>
            </div>
            <div class="statusline" id="summaryStatus"></div>
          </div>

          <div class="statusline" id="dashStatus"></div>

          <!-- Dealer actions -->
          <div class="panel" id="dealerActions" style="margin-top:10px">
            <h3>Create dealer</h3>
            <div class="hint">Adds a dealer profile (Dealers table). Passcode is stored hashed server-side.</div>

            <div class="field">
              <div class="label"><span>Dealer name</span><span>Required</span></div>
              <input id="newDealerName" class="input" placeholder="Pytch Motors" />
            </div>

            <div class="row two">
              <div class="field">
                <div class="label"><span>Dealer ID</span><span>3‚Äì40 chars</span></div>
                <input id="newDealerId" class="input" placeholder="DEALER-0001" maxlength="40" />
              </div>
              <div class="field">
                <div class="label"><span>Status</span><span>Default</span></div>
                <select id="newDealerStatus" class="select">
                  <option value="active">Active</option>
                  <option value="paused">Paused</option>
                </select>
              </div>
            </div>

            <div class="field">
              <div class="label"><span>Plan</span><span>Subscription tier</span></div>
              <select id="newDealerPlan" class="select">
                <option value="">Select plan</option>
                <option value="tier1">Tier 1</option>
                <option value="tier2">Tier 2</option>
                <option value="tier3">Tier 3</option>
              </select>
            </div>

            <div class="field">
              <div class="label"><span>Passcode</span><span>Optional</span></div>
              <input id="newDealerPasscode" class="input" placeholder="123456" />
            </div>

            <div class="row two">
              <div class="field">
                <div class="label"><span>WhatsApp</span><span>Optional</span></div>
                <input id="newDealerWhatsApp" class="input" placeholder="8765550123" />
              </div>
              <div class="field">
                <div class="label"><span>Logo URL</span><span>Optional</span></div>
                <input id="newDealerLogo" class="input" placeholder="https://..." />
              </div>
            </div>

            <div class="splitBtns">
              <button class="btn btn-ghost" id="btnOpenDealerModal" type="button">Open editor</button>
              <button class="btn btn-primary" id="btnCreateDealer" type="button">Create dealer</button>
            </div>

            <div class="statusline" id="dealerActionStatus"></div>
            
            <!-- #23 Export Buttons & #24 Bulk Actions -->
            <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--line)">
              <h4 style="margin:0 0 12px;font-size:14px;color:var(--muted)">Export & Bulk Actions</h4>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-ghost" id="btnExportDealers" type="button" data-testid="export-dealers-btn">üì• Export Dealers CSV</button>
                <button class="btn btn-ghost" id="btnExportVehicles" type="button" data-testid="export-vehicles-btn">üì• Export Vehicles CSV</button>
                <button class="btn btn-ghost" id="btnExportRequests" type="button" data-testid="export-requests-btn">üì• Export Requests CSV</button>
              </div>
              <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <select id="bulkStatusSelect" class="select" style="width:auto">
                  <option value="">Bulk status...</option>
                  <option value="available">Mark Available</option>
                  <option value="sold">Mark Sold</option>
                  <option value="archived">Archive</option>
                </select>
                <button class="btn btn-ghost" id="btnBulkUpdate" type="button" data-testid="bulk-update-btn">Apply to Selected</button>
                <span class="hint" id="bulkHint" style="font-size:12px">Select vehicles in table first</span>
              </div>
              <div style="margin-top:12px">
                <button class="btn btn-ghost" id="btnCheckAlerts" type="button" data-testid="check-alerts-btn">üîî Send Alert Emails</button>
                <span class="hint" style="font-size:12px;margin-left:8px">Sends low inventory & upgrade prompts</span>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="table-shell" id="mainTable">
          <div class="table-head">
            <div>
              <div class="table-title" id="tableTitle">Dealers</div>
              <div class="table-meta">Showing <span id="count">0</span> rows</div>
            </div>
            <div class="table-meta" id="lastUpdated">‚Äî</div>
          </div>

          <div class="scroll">
            <table>
              <thead><tr id="theadRow"></tr></thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>

        <!-- Summary panel -->
        <div class="panel hidden" id="summaryPanel">
          <h3>All dealers summary</h3>
          <div class="hint">Fast admin load: one request returns KPIs for every dealer.</div>

          <div class="kpis" style="margin-top:10px">
            <div class="kpi"><div class="t">Dealers</div><div class="v" id="sDealers">0</div><div class="s">Total</div></div>
            <div class="kpi"><div class="t">Active</div><div class="v" id="sActive">0</div><div class="s">Dealers live</div></div>
            <div class="kpi"><div class="t">Available</div><div class="v" id="sAvailable">0</div><div class="s">Vehicles in stock</div></div>
            <div class="kpi"><div class="t">Requests</div><div class="v" id="sRequests">0</div><div class="s">Month total</div></div>
          </div>

          <div class="table-shell" style="margin-top:10px">
            <div class="table-head">
              <div>
                <div class="table-title">Dealers KPIs</div>
                <div class="table-meta">Showing <span id="sCount">0</span> dealers</div>
              </div>
              <div class="table-meta" id="sUpdated">‚Äî</div>
            </div>
            <div class="scroll">
              <table>
                <thead>
                  <tr>
                    <th>Dealer</th>
                    <th>Status</th>
                    <th>Inventory</th>
                    <th>Available</th>
                    <th>Requests</th>
                    <th>New</th>
                    <th>Booked</th>
                  </tr>
                </thead>
                <tbody id="sBody"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- DEALER EDIT MODAL -->
  <div class="backdrop" id="dealerBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Dealer editor">
      <div class="mhead">
        <div>
          <h3 id="mTitle">Dealer editor</h3>
          <div class="sub" style="font-size:12px;color:var(--muted)" id="mSub">Edit dealer profile and reset passcode.</div>
        </div>
        <button class="xbtn" id="mClose" type="button" aria-label="Close">√ó</button>
      </div>

      <div class="mbody">
        <div class="row two">
          <div class="field">
            <div class="label"><span>Dealer name</span></div>
            <input id="mDealerName" class="input" />
          </div>
          <div class="field">
            <div class="label"><span>Dealer ID</span></div>
            <input id="mDealerId" class="input" maxlength="40" />
          </div>
        </div>

        <div class="row two">
          <div class="field">
            <div class="label"><span>Status</span></div>
            <select id="mDealerStatus" class="select">
              <option value="active">Active</option>
              <option value="paused">Paused</option>
            </select>
          </div>
          <div class="field">
            <div class="label"><span>WhatsApp</span></div>
            <input id="mDealerWhatsApp" class="input" placeholder="8765550123" />
          </div>
        </div>

        <div class="field">
          <div class="label"><span>Plan</span></div>
          <select id="mDealerPlan" class="select">
            <option value="">Select plan</option>
            <option value="tier1">Tier 1</option>
            <option value="tier2">Tier 2</option>
            <option value="tier3">Tier 3</option>
          </select>
        </div>

        <div class="field">
          <div class="label"><span>Passcode (optional set)</span></div>
          <input id="mDealerPasscode" class="input" placeholder="123456" />
        </div>

        <div class="field">
          <div class="label"><span>Logo URL</span></div>
          <input id="mDealerLogo" class="input" placeholder="https://..." />
        </div>

        <div class="panel" style="margin-top:10px">
          <h3>Passcode reset</h3>
          <div class="hint">Reset generates a fresh passcode for the dealer (server returns it once).</div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top:8px">
            <div class="pill" style="box-shadow:none">
              <span class="dot on" style="box-shadow:none"></span>
              <span>Latest passcode: <span class="mono" id="mPasscode">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></span>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="btn btn-danger" id="btnResetPasscode" type="button">Reset passcode</button>
              <button class="btn btn-primary" id="btnSaveDealer" type="button">Save changes</button>
            </div>
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
            <button class="btn btn-ghost" id="btnViewDealerInventory" type="button">View inventory</button>
            <button class="btn btn-ghost" id="btnViewDealerRequests" type="button">View requests</button>
          </div>

          <div class="statusline" id="mStatus"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast">
    <div id="toastDot"></div>
    <div id="toastMsg"></div>
  </div>

  <script>
    // ========= API endpoints =========
    const API = {
      login: () => "/api/admin/login",
      dealers: () => "/api/admin/dealers",
      resetPass: () => "/api/admin/reset-passcode",
      inventory: () => "/api/admin/inventory",
      requests: () => "/api/admin/requests",
      summary: (month) => `/api/admin/dealers/summary?month=${encodeURIComponent(month)}`
    };

    const el = (id) => document.getElementById(id);

    const ui = {
      loginView: el("loginView"),
      dashView: el("dashView"),
      username: el("username"),
      password: el("password"),
      btnLogin: el("btnLogin"),
      btnDemo: el("btnDemo"),
      loginStatus: el("loginStatus"),

      whoami: el("whoami"),
      apiDot: el("apiDot"),
      apiStatus: el("apiStatus"),
      btnRefresh: el("btnRefresh"),
      btnLogout: el("btnLogout"),

      tabDealers: el("tabDealers"),
      tabSummary: el("tabSummary"),
      tabInventory: el("tabInventory"),
      tabRequests: el("tabRequests"),
      tabSettings: el("tabSettings"),

      hint: el("hint"),
      q: el("q"),
      statusFilterWrap: el("statusFilterWrap"),
      statusFilter: el("statusFilter"),

      tableTitle: el("tableTitle"),
      theadRow: el("theadRow"),
      tbody: el("tbody"),
      count: el("count"),
      lastUpdated: el("lastUpdated"),
      dashStatus: el("dashStatus"),

      dealerActions: el("dealerActions"),
      newDealerName: el("newDealerName"),
      newDealerId: el("newDealerId"),
      newDealerStatus: el("newDealerStatus"),
      newDealerPlan: el("newDealerPlan"),
      newDealerPasscode: el("newDealerPasscode"),
      newDealerWhatsApp: el("newDealerWhatsApp"),
      newDealerLogo: el("newDealerLogo"),
      btnCreateDealer: el("btnCreateDealer"),
      btnOpenDealerModal: el("btnOpenDealerModal"),
      dealerActionStatus: el("dealerActionStatus"),
      
      // #23 Export & #24 Bulk Actions
      btnExportDealers: el("btnExportDealers"),
      btnExportVehicles: el("btnExportVehicles"),
      btnExportRequests: el("btnExportRequests"),
      bulkStatusSelect: el("bulkStatusSelect"),
      btnBulkUpdate: el("btnBulkUpdate"),
      bulkHint: el("bulkHint"),
      btnCheckAlerts: el("btnCheckAlerts"),

      // Summary
      summaryControls: el("summaryControls"),
      summaryMonth: el("summaryMonth"),
      btnLoadSummary: el("btnLoadSummary"),
      summaryStatus: el("summaryStatus"),
      summaryPanel: el("summaryPanel"),
      sDealers: el("sDealers"),
      sActive: el("sActive"),
      sAvailable: el("sAvailable"),
      sRequests: el("sRequests"),
      sCount: el("sCount"),
      sUpdated: el("sUpdated"),
      sBody: el("sBody"),

      // Modal
      dealerBackdrop: el("dealerBackdrop"),
      mClose: el("mClose"),
      mDealerName: el("mDealerName"),
      mDealerId: el("mDealerId"),
      mDealerStatus: el("mDealerStatus"),
      mDealerPlan: el("mDealerPlan"),
      mDealerWhatsApp: el("mDealerWhatsApp"),
      mDealerPasscode: el("mDealerPasscode"),
      mDealerLogo: el("mDealerLogo"),
      mPasscode: el("mPasscode"),
      btnResetPasscode: el("btnResetPasscode"),
      btnSaveDealer: el("btnSaveDealer"),
      btnViewDealerInventory: el("btnViewDealerInventory"),
      btnViewDealerRequests: el("btnViewDealerRequests"),
      mStatus: el("mStatus"),

      toast: el("toast"),
      toastDot: el("toastDot"),
      toastMsg: el("toastMsg"),
    };

    const state = {
      tab: "dealers",
      token: null,
      apiOnline: true,

      dealers: [],
      vehicles: [],
      requests: [],

      selectedDealer: null,
      demoPasscodes: {}
    };

    // ========= Boot =========
    document.addEventListener("DOMContentLoaded", () => {
      // Wire buttons (this is what makes them NOT "dead")
      wire();

      // Restore token if present
      const saved = sessionStorage.getItem("ADMIN_TOKEN");
      if(saved){
        state.token = saved;
        enterDashboard("admin");
        refresh().catch(()=>{});
      } else {
        setApi("Login", "err");
      }

      // default month
      ui.summaryMonth.value = new Date().toISOString().slice(0,7);
    });

    function wire(){
      ui.btnLogin.addEventListener("click", doLogin);
      ui.btnDemo.addEventListener("click", enterDemo);
      ui.password.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

      ui.btnLogout.addEventListener("click", logout);
      ui.btnRefresh.addEventListener("click", () => refresh().catch(()=>{}));

      [ui.tabDealers, ui.tabSummary, ui.tabInventory, ui.tabRequests, ui.tabSettings].forEach(btn=>{
        btn.addEventListener("click", ()=> setTab(btn.dataset.tab));
      });

      ui.q.addEventListener("keydown", (e)=>{ if(e.key==="Enter") render(); });
      ui.statusFilter.addEventListener("change", render);

      ui.btnCreateDealer.addEventListener("click", createDealer);
      ui.btnOpenDealerModal.addEventListener("click", () => {
        if(!state.dealers.length) return toast("No dealers yet. Create one first.", "error");
        openDealerModal(state.dealers[0]);
      });

      ui.mClose.addEventListener("click", closeDealerModal);
      ui.dealerBackdrop.addEventListener("click", (e)=>{ if(e.target === ui.dealerBackdrop) closeDealerModal(); });

      ui.btnResetPasscode.addEventListener("click", resetPasscode);
    ui.btnSaveDealer.addEventListener("click", saveDealerChanges);
    ui.btnViewDealerInventory.addEventListener("click", () => {
      if(!state.selectedDealer) return;
      switchTab("inventory");
      ui.q.value = state.selectedDealer.dealerId || "";
      render();
      closeDealerModal();
    });
    ui.btnViewDealerRequests.addEventListener("click", () => {
      if(!state.selectedDealer) return;
      switchTab("requests");
      ui.q.value = state.selectedDealer.dealerId || "";
      render();
      closeDealerModal();
    });

      ui.btnLoadSummary.addEventListener("click", () => loadSummary().catch(()=>{}));
    }

    // ========= Auth =========
    async function doLogin(){
      const username = (ui.username.value||"").trim();
      const password = (ui.password.value||"").trim();
      if(!username || !password) return setLoginStatus("Enter username + password.", true);

      setLoginStatus("Signing in‚Ä¶", false);

      try{
        const res = await fetch(API.login(), {
          method:"POST",
          headers:{ "Content-Type":"application/json", "Accept":"application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await safeJson(res);

        if(!res.ok || !data?.ok){
          throw new Error(data?.error || `Login failed (${res.status})`);
        }

        state.apiOnline = true;
        state.token = data.token;
        sessionStorage.setItem("ADMIN_TOKEN", state.token);

        setApi("Live", "on");
        enterDashboard(username);
        toast("Signed in.", "success");
      }catch(e){
        setApi("Error", "err");
        setLoginStatus(e?.message || "API login failed.", true);
        toast("Login failed.", "error");
      }
    }

    function enterDemo(){
      state.apiOnline = false;
      state.token = "demo-token";
      sessionStorage.setItem("ADMIN_TOKEN", state.token);
      setApi("Demo", "err");
      enterDashboard("admin-demo");
      seedDemoIfNeeded();
      render();
    }

    function enterDashboard(username){
      ui.loginView.classList.add("hidden");
      ui.dashView.classList.remove("hidden");
      ui.whoami.textContent = `Admin ¬∑ ${username}`;
      setTab(state.tab || "dealers");
    }

    function logout(){
      sessionStorage.removeItem("ADMIN_TOKEN");
      state.token = null;
      state.apiOnline = true;
      state.dealers = [];
      state.vehicles = [];
      state.requests = [];
      state.selectedDealer = null;
      clearTimeout(adminSessionTimeout); // #11 Clear session timeout

      ui.dashView.classList.add("hidden");
      ui.loginView.classList.remove("hidden");
      ui.loginStatus.textContent = "";
      setApi("Login", "err");
      toast("Logged out.", "success");
    }
    
    // #11 Session Timeout - Auto logout after 30 minutes of inactivity
    let adminSessionTimeout;
    const ADMIN_SESSION_TIMEOUT_MS = 30 * 60 * 1000; // 30 minutes
    
    function resetAdminSessionTimeout() {
      clearTimeout(adminSessionTimeout);
      if (state.token) {
        adminSessionTimeout = setTimeout(() => {
          alert('Session expired due to inactivity. Please log in again.');
          logout();
        }, ADMIN_SESSION_TIMEOUT_MS);
      }
    }
    
    // Reset timeout on user activity
    ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
      document.addEventListener(event, resetAdminSessionTimeout, { passive: true });
    });

    function authHeaders(){
      return {
        "Accept":"application/json",
        "Authorization":"Bearer " + state.token
      };
    }

    // ========= Tabs =========
    function setTab(tab){
      state.tab = tab;

      ui.tabDealers?.classList.toggle("active", tab==="dealers");
      ui.tabSummary?.classList.toggle("active", tab==="summary");
      ui.tabInventory?.classList.toggle("active", tab==="inventory");
      ui.tabRequests?.classList.toggle("active", tab==="requests");
      ui.tabSettings?.classList.toggle("active", tab==="settings");

      ui.tableTitle.textContent =
        tab==="dealers" ? "Dealers"
        : tab==="inventory" ? "Inventory"
        : tab==="requests" ? "Viewing requests"
        : tab==="settings" ? "Platform settings"
        : "Summary";

      ui.hint.textContent =
        tab==="dealers" ? "Create and manage dealer accounts. Click a row to edit."
        : tab==="summary" ? "Loads KPIs for all dealers in one request."
        : tab==="inventory" ? "View all vehicles."
        : tab==="requests" ? "View all viewing requests."
        : "Env-driven settings.";

      ui.dealerActions?.classList.toggle("hidden", tab!=="dealers");
      ui.summaryControls?.classList.toggle("hidden", tab!=="summary");
      ui.summaryPanel?.classList.toggle("hidden", tab!=="summary");
      ui.mainTable?.classList.toggle("hidden", tab==="summary");

      buildStatusFilterOptions(tab);
      buildTableHeaders(tab);

      refresh().catch(()=>{});
    }

    function buildStatusFilterOptions(tab){
      ui.statusFilter.innerHTML = "";
      const add = (v,t)=>{ const o=document.createElement("option"); o.value=v; o.textContent=t; ui.statusFilter.appendChild(o); };
      add("", "All");

      if(tab==="dealers"){ add("active","Active"); add("paused","Paused"); }
      else if(tab==="inventory"){ add("available","Available"); add("pending","Pending"); add("sold","Sold"); }
      else if(tab==="requests"){ add("new","New"); add("booked","Booked"); add("closed","Closed"); }

      ui.statusFilterWrap?.classList.toggle("hidden", tab==="settings" || tab==="summary");
    }

    function buildTableHeaders(tab){
      ui.theadRow.innerHTML = "";
      const cols =
        tab==="dealers" ? ["Dealer", "Dealer ID", "Status", "Plan", "WhatsApp", "Logo", "Actions"]
        : tab==="inventory" ? ["Vehicle", "Dealer", "Status", "Price", "Updated"]
        : tab==="requests" ? ["Customer", "Vehicle", "Dealer", "Type", "Status", "Requested"]
        : ["Item", "Value", "Hint"];

      cols.forEach(c=>{ const th=document.createElement("th"); th.textContent=c; ui.theadRow.appendChild(th); });
    }

    // ========= Data refresh =========
    async function refresh(){
      ui.dashStatus.textContent = state.apiOnline ? "Loading from API‚Ä¶" : "Loading demo data‚Ä¶";
      ui.lastUpdated.textContent = "Updated: " + fmt(new Date());

      try{
        if(!state.apiOnline){
          seedDemoIfNeeded();
          ui.dashStatus.textContent = "Ready (demo).";
          render();
          return;
        }

        if(state.tab==="dealers"){
          const res = await fetch(API.dealers(), { headers: authHeaders() });
          const data = await safeJson(res);
          if(!res.ok || !data?.ok) throw new Error(data?.error || "Failed to load dealers");
          state.dealers = Array.isArray(data.dealers) ? data.dealers : [];
        }

        // These two are optional ‚Äî if you haven't built them yet, UI won't break.
        if(state.tab==="inventory"){
          const res = await fetch(API.inventory(), { headers: authHeaders() });
          const data = await safeJson(res);
          if(res.ok && data?.ok) state.vehicles = Array.isArray(data.vehicles) ? data.vehicles : [];
          else state.vehicles = [];
        }

        if(state.tab==="requests"){
          const res = await fetch(API.requests(), { headers: authHeaders() });
          const data = await safeJson(res);
          if(res.ok && data?.ok) state.requests = Array.isArray(data.requests) ? data.requests : [];
          else state.requests = [];
        }

        if(state.tab==="summary"){
          await loadSummary();
        }

        ui.dashStatus.textContent = "Ready.";
        setApi("Live", "on");
        render();
      }catch(e){
        ui.dashStatus.textContent = "Could not load from API.";
        setApi("Error", "err");
        toast("API error: " + (e?.message||"failed"), "error");
      }
    }

    async function loadSummary(){
      ui.summaryStatus.textContent = "";
      const month = ui.summaryMonth.value || new Date().toISOString().slice(0,7);

      if(!state.apiOnline){
        ui.summaryStatus.textContent = "Summary not available in demo (seeded data only).";
        ui.summaryStatus.classList.remove("error");
        renderSummaryFromDemo(month);
        return;
      }

      try{
        ui.summaryStatus.textContent = "Loading summary‚Ä¶";
        const res = await fetch(API.summary(month), { headers: authHeaders() });
        const data = await safeJson(res);

        if(!res.ok || !data?.ok){
          throw new Error(data?.error || `Summary failed (${res.status})`);
        }

        // expected:
        // data.summary: { month, totals:{ dealers, activeDealers, availableVehicles, requests }, dealers:[{ dealerId,name,status,inventory,available,requests,new,booked }] }
        const s = data.summary || {};
        const totals = s.totals || {};
        const dealers = Array.isArray(s.dealers) ? s.dealers : [];

        ui.sDealers.textContent = String(totals.dealers ?? dealers.length ?? 0);
        ui.sActive.textContent = String(totals.activeDealers ?? dealers.filter(d => (d.status||"").toLowerCase()==="active").length);
        ui.sAvailable.textContent = String(totals.availableVehicles ?? dealers.reduce((a,d)=>a+Number(d.available||0),0));
        ui.sRequests.textContent = String(totals.requests ?? dealers.reduce((a,d)=>a+Number(d.requests||0),0));

        ui.sBody.innerHTML = "";
        ui.sCount.textContent = String(dealers.length);
        ui.sUpdated.textContent = "Updated: " + fmt(new Date());

        if(!dealers.length){
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 7;
          td.style.color = "var(--muted)";
          td.style.padding = "14px";
          td.textContent = "No summary rows returned.";
          tr.appendChild(td);
          ui.sBody.appendChild(tr);
        } else {
          dealers.forEach((d)=>{
            const tr = document.createElement("tr");
            tr.appendChild(cell(`<div style="font-weight:900">${esc(d.name||d.dealerId||"‚Äî")}</div><div class="mono" style="color:var(--muted)">${esc(d.dealerId||"")}</div>`));
            tr.appendChild(cell(statusPill(d.status)));
            tr.appendChild(cell(`<span class="badgeMini">${Number(d.inventory||0)} vehicles</span>`));
            tr.appendChild(cell(`<span class="badgeMini">${Number(d.available||0)} available</span>`));
            tr.appendChild(cell(`<span class="badgeMini">${Number(d.requests||0)} req</span>`));
            tr.appendChild(cell(`<span class="badgeMini">${Number(d.new||0)} new</span>`));
            tr.appendChild(cell(`<span class="badgeMini">${Number(d.booked||0)} booked</span>`));
            ui.sBody.appendChild(tr);
          });
        }

        ui.summaryStatus.textContent = "Ready.";
      }catch(e){
        ui.summaryStatus.textContent = "Summary failed: " + (e?.message || "error");
        ui.summaryStatus.classList.add("error");
      }
    }

    function renderSummaryFromDemo(_month){
      // minimal demo display from seeded dealers
      const dealers = state.dealers.map(d => ({
        dealerId: d.dealerId,
        name: d.name,
        status: d.status,
        inventory: Number(d.vehicleCount||0),
        available: Math.max(0, Number(d.vehicleCount||0)-2),
        requests: 0,
        new: 0,
        booked: 0
      }));

      ui.sDealers.textContent = String(dealers.length);
      ui.sActive.textContent = String(dealers.filter(d=> (d.status||"").toLowerCase()==="active").length);
      ui.sAvailable.textContent = String(dealers.reduce((a,d)=>a+Number(d.available||0),0));
      ui.sRequests.textContent = "0";
      ui.sBody.innerHTML = "";
      ui.sCount.textContent = String(dealers.length);
      ui.sUpdated.textContent = "Updated: " + fmt(new Date());

      dealers.forEach((d)=>{
        const tr = document.createElement("tr");
        tr.appendChild(cell(`<div style="font-weight:900">${esc(d.name||d.dealerId||"‚Äî")}</div><div class="mono" style="color:var(--muted)">${esc(d.dealerId||"")}</div>`));
        tr.appendChild(cell(statusPill(d.status)));
        tr.appendChild(cell(`<span class="badgeMini">${Number(d.inventory||0)} vehicles</span>`));
        tr.appendChild(cell(`<span class="badgeMini">${Number(d.available||0)} available</span>`));
        tr.appendChild(cell(`<span class="badgeMini">${Number(d.requests||0)} req</span>`));
        tr.appendChild(cell(`<span class="badgeMini">${Number(d.new||0)} new</span>`));
        tr.appendChild(cell(`<span class="badgeMini">${Number(d.booked||0)} booked</span>`));
        ui.sBody.appendChild(tr);
      });
    }

    // ========= Render tables =========
    function render(){
      if(state.tab === "summary"){
        // summary is its own panel
        ui.count.textContent = "0";
        return;
      }

      const q = (ui.q.value||"").trim().toLowerCase();
      const f = (ui.statusFilter.value||"").trim().toLowerCase();

      let rows = [];
      if(state.tab==="dealers") rows = [...state.dealers];
      if(state.tab==="inventory") rows = [...state.vehicles];
      if(state.tab==="requests") rows = [...state.requests];
      if(state.tab==="settings") rows = settingsRows();

      if(q){
        rows = rows.filter(r => JSON.stringify(r).toLowerCase().includes(q));
      }
      if(f && state.tab!=="settings"){
        rows = rows.filter(r => (r.status||"").toLowerCase() === f);
      }

      ui.tbody.innerHTML = "";
      ui.count.textContent = String(rows.length);

      if(!rows.length){
        const tr=document.createElement("tr");
        const td=document.createElement("td");
        td.colSpan = state.tab==="dealers" ? 7 : (state.tab==="requests" ? 6 : 5);
        td.style.color="var(--muted)";
        td.style.padding="14px";
        td.textContent="No rows match your filters.";
        tr.appendChild(td);
        ui.tbody.appendChild(tr);
        return;
      }

      rows.forEach(r=>{
        const tr=document.createElement("tr");

        if(state.tab==="dealers"){
          tr.style.cursor="pointer";
          tr.addEventListener("click", ()=> openDealerModal(r));

          tr.appendChild(cell(`<div style="font-weight:900">${esc(r.name||"‚Äî")}</div><div style="color:var(--muted);font-size:11px;margin-top:2px">Click to edit</div>`));
          tr.appendChild(cell(`<span class="mono">${esc(r.dealerId||"‚Äî")}</span>`));
          tr.appendChild(cell(statusPill(r.status)));
          tr.appendChild(cell(`<span class="badgeMini">${esc(r.plan||"‚Äî")}</span>`));
          tr.appendChild(cell(r.whatsapp ? `<span class="badgeMini">+${esc(r.whatsapp)}</span>` : `<span style="color:var(--muted)">‚Äî</span>`));
          tr.appendChild(cell(r.logoUrl ? `<a class="mono" href="${escAttr(r.logoUrl)}" target="_blank" rel="noreferrer">logo</a>` : `<span style="color:var(--muted)">‚Äî</span>`));

          const actions = document.createElement("td");
          actions.innerHTML = `<button class="btn btn-ghost" type="button">Edit</button>`;
          tr.appendChild(actions);
        }

        if(state.tab==="inventory"){
          tr.appendChild(cell(`<div class="mono">${esc(r.vehicleId||r.id||"‚Äî")}</div><div style="color:var(--muted);font-size:11px;margin-top:2px">${esc(r.make||"")} ${esc(r.model||"")}</div>`));
          tr.appendChild(cell(`<span class="badgeMini">${esc(r.dealerId||"‚Äî")}</span>`));
          tr.appendChild(cell(`<span class="badgeMini">${esc(r.status||"‚Äî")}</span>`));
          tr.appendChild(cell(`<div style="font-weight:900">${money(r.price)}</div>`));
          tr.appendChild(cell(`<span class="mono">${esc(r.updatedAt||r.createdAt||"‚Äî")}</span>`));
        }

        if(state.tab==="requests"){
          tr.appendChild(cell(`<div style="font-weight:900">${esc(r.name||r.customer||"‚Äî")}</div><div style="color:var(--muted);font-size:11px;margin-top:2px">${esc(r.phone||"")}</div>`));
          tr.appendChild(cell(`<div class="mono">${esc(r.vehicleId||"‚Äî")}</div>`));
          tr.appendChild(cell(`<span class="badgeMini">${esc(r.dealerId||"‚Äî")}</span>`));
          tr.appendChild(cell(`<span class="badgeMini">${esc(r.type||"‚Äî")}</span>`));
          tr.appendChild(cell(`<span class="badgeMini">${esc(r.status||"‚Äî")}</span>`));
          tr.appendChild(cell(`<span class="mono">${esc(r.createdAt||"‚Äî")}</span>`));
        }

        if(state.tab==="settings"){
          tr.appendChild(cell(`<div style="font-weight:900">${esc(r.item)}</div>`));
          tr.appendChild(cell(`<span class="mono">${esc(r.value)}</span>`));
          tr.appendChild(cell(`<span style="color:var(--muted)">${esc(r.hint)}</span>`));
        }

        ui.tbody.appendChild(tr);
      });
    }

    function settingsRows(){
      return [
        { item:"ADMIN_USERNAME", value:"(Cloud Run env)", hint:"Admin login username" },
        { item:"ADMIN_PASSWORD", value:"(Cloud Run env)", hint:"Admin login password" },
        { item:"JWT_SECRET", value:"(Cloud Run env)", hint:"Token signing secret" },
        { item:"AIRTABLE_API_KEY", value:"(Cloud Run env)", hint:"Airtable PAT token" },
        { item:"AIRTABLE_BASE_ID", value:"(Cloud Run env)", hint:"Airtable base id" },
      ];
    }

    // ========= Create dealer =========
    async function createDealer(){
        const payload = {
          name: (ui.newDealerName.value||"").trim(),
          dealerId: (ui.newDealerId.value||"").trim(),
          status: (ui.newDealerStatus.value||"active").toLowerCase(),
          plan: (ui.newDealerPlan.value||"").trim().toLowerCase(),
          passcode: (ui.newDealerPasscode.value||"").trim(),
          whatsapp: digits(ui.newDealerWhatsApp.value||""),
          logoUrl: (ui.newDealerLogo.value||"").trim(),
        };

      if(!payload.name || !payload.dealerId){
        ui.dealerActionStatus.textContent = "Dealer name and ID are required.";
        ui.dealerActionStatus.classList.add("error");
        return;
      }

      ui.dealerActionStatus.textContent = "Creating‚Ä¶";
      ui.dealerActionStatus.classList.remove("error");

      try{
        if(!state.apiOnline){
          seedDemoIfNeeded();
          const pass = payload.passcode || String(Math.floor(100000 + Math.random()*900000));
          state.demoPasscodes[payload.dealerId] = pass;

          state.dealers.unshift({
            name: payload.name,
            dealerId: payload.dealerId,
            status: payload.status,
            whatsapp: payload.whatsapp,
            logoUrl: payload.logoUrl,
            vehicleCount: 0
          });

          ui.dealerActionStatus.textContent = `Created (demo). Passcode: ${pass}`;
          toast("Dealer created.", "success");
          clearCreateInputs();
          render();
          return;
        }

        const res = await fetch(API.dealers(), {
          method:"POST",
          headers:{ ...authHeaders(), "Content-Type":"application/json", "Accept":"application/json" },
          body: JSON.stringify(payload)
        });
        const data = await safeJson(res);
        if(!res.ok || !data?.ok) throw new Error(data?.error || "Create failed");

        const pass = data.passcode ? ` New passcode: ${data.passcode}` : "";
        ui.dealerActionStatus.textContent = `Created.${pass}`;
        toast("Dealer created.", "success");
        clearCreateInputs();
        await refresh();
      }catch(e){
        ui.dealerActionStatus.textContent = "Failed to create dealer: " + (e?.message||"error");
        ui.dealerActionStatus.classList.add("error");
        toast("Create failed.", "error");
      }
    }

    function clearCreateInputs(){
      ui.newDealerName.value = "";
      ui.newDealerId.value = "";
      ui.newDealerPasscode.value = "";
      ui.newDealerWhatsApp.value = "";
      ui.newDealerLogo.value = "";
      ui.newDealerStatus.value = "active";
      ui.newDealerPlan.value = "";
    }

    // ========= Dealer modal =========
    function openDealerModal(dealer){
      state.selectedDealer = { ...dealer };
      ui.mStatus.textContent = "";
      ui.mStatus.classList.remove("error");

      ui.mDealerName.value = dealer.name || "";
      ui.mDealerId.value = dealer.dealerId || "";
      ui.mDealerStatus.value = (dealer.status || "active").toLowerCase();
      ui.mDealerPlan.value = (dealer.plan || "").toLowerCase();
      ui.mDealerWhatsApp.value = dealer.whatsapp || "";
      ui.mDealerPasscode.value = "";
      ui.mDealerLogo.value = dealer.logoUrl || "";

      ui.mPasscode.textContent = state.demoPasscodes[dealer.dealerId] || "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";

      ui.dealerBackdrop.classList.add("show");
      ui.dealerBackdrop.setAttribute("aria-hidden","false");
    }

    function closeDealerModal(){
      ui.dealerBackdrop.classList.remove("show");
      ui.dealerBackdrop.setAttribute("aria-hidden","true");
      state.selectedDealer = null;
    }

    async function saveDealerChanges(){
      if(!state.selectedDealer) return;

      const payload = {
        dealerId: (ui.mDealerId.value||"").trim(),
        name: (ui.mDealerName.value||"").trim(),
        status: (ui.mDealerStatus.value||"active").toLowerCase(),
        plan: (ui.mDealerPlan.value||"").trim().toLowerCase(),
        whatsapp: digits(ui.mDealerWhatsApp.value||""),
        passcode: (ui.mDealerPasscode.value||"").trim(), // optional
        logoUrl: (ui.mDealerLogo.value||"").trim(),
      };

      if(!payload.dealerId || !payload.name){
        ui.mStatus.textContent = "Dealer ID and name are required.";
        ui.mStatus.classList.add("error");
        return;
      }

      ui.mStatus.textContent = "Saving‚Ä¶";
      ui.mStatus.classList.remove("error");

      try{
        if(!state.apiOnline){
          const idx = state.dealers.findIndex(d => d.dealerId === state.selectedDealer.dealerId);
          if(idx > -1) state.dealers[idx] = { ...state.dealers[idx], ...payload };
          ui.mStatus.textContent = "Saved (demo).";
          toast("Dealer updated.", "success");
          render();
          return;
        }

        const res = await fetch(API.dealers(), {
          method:"POST",
          headers:{ ...authHeaders(), "Content-Type":"application/json", "Accept":"application/json" },
          body: JSON.stringify(payload)
        });
        const data = await safeJson(res);
        if(!res.ok || !data?.ok) throw new Error(data?.error || "Save failed");

        ui.mStatus.textContent = "Saved.";
        toast("Dealer updated.", "success");
        await refresh();
      }catch(e){
        ui.mStatus.textContent = "Failed to save: " + (e?.message||"error");
        ui.mStatus.classList.add("error");
        toast("Save failed.", "error");
      }
    }

    async function resetPasscode(){
      if(!state.selectedDealer) return;

      const dealerId = (ui.mDealerId.value||"").trim();
      if(!dealerId) return;

      ui.mStatus.textContent = "Resetting‚Ä¶";
      ui.mStatus.classList.remove("error");

      try{
        if(!state.apiOnline){
          const newPass = String(Math.floor(100000 + Math.random()*900000));
          state.demoPasscodes[dealerId] = newPass;
          ui.mPasscode.textContent = newPass;
          ui.mStatus.textContent = "Passcode reset (demo).";
          toast("Passcode reset.", "success");
          return;
        }

        const res = await fetch(API.resetPass(), {
          method:"POST",
          headers:{ ...authHeaders(), "Content-Type":"application/json", "Accept":"application/json" },
          body: JSON.stringify({ dealerId })
        });
        const data = await safeJson(res);
        if(!res.ok || !data?.ok) throw new Error(data?.error || "Reset failed");

        if(data.passcode) ui.mPasscode.textContent = String(data.passcode);
        ui.mStatus.textContent = "Passcode reset.";
        toast("Passcode reset.", "success");
        await refresh();
      }catch(e){
        ui.mStatus.textContent = "Failed to reset: " + (e?.message||"error");
        ui.mStatus.classList.add("error");
        toast("Reset failed.", "error");
      }
    }

    // ========= Demo seed =========
    function seedDemoIfNeeded(){
      if(state.dealers.length) return;
      state.dealers = [
        { name:"Pytch Motors", dealerId:"DEALER-0001", status:"active", whatsapp:"8765550123", logoUrl:"", vehicleCount:12 },
        { name:"Island Auto", dealerId:"DEALER-0002", status:"active", whatsapp:"8765550199", logoUrl:"", vehicleCount:7 },
        { name:"Mobay Cars", dealerId:"DEALER-0003", status:"paused", whatsapp:"", logoUrl:"", vehicleCount:3 },
      ];
      state.demoPasscodes["DEALER-0001"] = "123456";
    }

    // ========= UI helpers =========
    function cell(html){ const td=document.createElement("td"); td.innerHTML=html; return td; }

    function statusPill(s){
      const v = (s||"active").toLowerCase();
      const cls = v==="paused" ? "paused" : "active";
      return `<span class="status ${cls}">${esc(v)}</span>`;
    }

    function setApi(text, mode){
      ui.apiStatus.textContent = text || "‚Äî";
      ui.apiDot.classList.remove("on","err");
      if(mode==="on") ui.apiDot.classList.add("on");
      if(mode==="err") ui.apiDot.classList.add("err");
    }

    function setLoginStatus(msg, err){
      ui.loginStatus.textContent = msg || "";
      ui.loginStatus.classList.toggle("error", !!err);
    }

    function toast(message, type){
      ui.toastMsg.textContent = message || "";
      ui.toast.classList.remove("success","error");
      if(type==="success"){ ui.toast.classList.add("success"); ui.toastDot.style.background="#22c55e"; }
      else if(type==="error"){ ui.toast.classList.add("error"); ui.toastDot.style.background="#ef4444"; }
      else ui.toastDot.style.background="var(--brand)";
      ui.toast.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>ui.toast.classList.remove("show"), 3200);
    }

    async function safeJson(res){ try{ return await res.json(); }catch(_){ return null; } }

    function money(n){
      const v = Number(n);
      if(!Number.isFinite(v) || v<=0) return "‚Äî";
      return "JMD " + v.toLocaleString(undefined,{maximumFractionDigits:0});
    }

    function fmt(d){
      const dt = (d instanceof Date)?d:new Date(d);
      const day = String(dt.getDate()).padStart(2,"0");
      const mon = String(dt.getMonth()+1).padStart(2,"0");
      const yr = String(dt.getFullYear()).slice(-2);
      const hr = String(dt.getHours()).padStart(2,"0");
      const mi = String(dt.getMinutes()).padStart(2,"0");
      return `${day}/${mon}/${yr} ${hr}:${mi}`;
    }

    function digits(s){ return String(s||"").replace(/\D+/g,"").trim(); }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }
    function escAttr(s){ return esc(s).replaceAll('"',"&quot;"); }
  </script>
</body>
</html>
