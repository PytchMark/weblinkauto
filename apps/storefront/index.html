<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <!-- #27 SEO Meta Tags - Dynamic (updated by JS) -->
  <title>Dealer Storefront ¬∑ Auto Concierge Jamaica</title>
  <meta name="description" content="Browse verified vehicles with real-time availability. Book viewings instantly via WhatsApp, live video, or walk-in. Jamaica's premier automotive marketplace." />
  <meta name="keywords" content="cars for sale Jamaica, used cars Jamaica, car dealership, vehicle marketplace, buy car Jamaica" />
  
  <!-- Open Graph / Social Sharing -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Auto Concierge Jamaica - Dealer Storefront" />
  <meta property="og:description" content="Browse verified vehicles with real-time availability. Book viewings instantly." />
  <meta property="og:image" content="https://res.cloudinary.com/dd8pjjxsm/image/upload/v1770298701/ChatGPT_Image_Sep_6_2025_08_27_53_AM_raorxf.png" />
  <meta property="og:url" content="https://autoconciergeja.com" />
  <meta property="og:site_name" content="Auto Concierge Jamaica" />
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Auto Concierge Jamaica - Dealer Storefront" />
  <meta name="twitter:description" content="Browse verified vehicles with real-time availability. Book viewings instantly." />
  <meta name="twitter:image" content="https://res.cloudinary.com/dd8pjjxsm/image/upload/v1770298701/ChatGPT_Image_Sep_6_2025_08_27_53_AM_raorxf.png" />
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://autoconciergeja.com" />

  <style>
    :root{
      --bg:#f7f7f8;
      --surface:#ffffff;
      --surface-soft:#fafafa;
      --ink:#0b0b0b;
      --muted:#6b7280;
      --muted-2:#9ca3af;

      --brand:#DC143C;
      --brand-2:#E53935;
      --brand-soft:#FDECEA;

      --line:#e5e7eb;
      --shadow:0 18px 40px rgba(15,23,42,.10);
      --shadow-soft:0 10px 24px rgba(15,23,42,.08);

      --radius:18px;
      --radius-lg:26px;

      --section:clamp(38px,5vw,64px);
      --gutter:clamp(16px,4vw,22px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(circle at 0% 0%, rgba(220,38,38,.06), transparent 45%),
        radial-gradient(circle at 80% 20%, rgba(239,68,68,.05), transparent 55%),
        var(--bg);
      -webkit-font-smoothing:antialiased;
    }

    img{max-width:100%;display:block}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:1180px;margin:0 auto;padding:0 var(--gutter)}

    header{
      position:sticky;top:0;z-index:20;
      background:rgba(255,255,255,.86);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }
    .marquee{
      background:#0b0b0b;
      color:#fff;
      font-size:11px;
      letter-spacing:.2em;
      text-transform:uppercase;
      overflow:hidden;
      border-bottom:1px solid rgba(255,255,255,.1);
    }
    .marquee-track{
      display:flex;
      gap:24px;
      padding:10px 0;
      white-space:nowrap;
      animation:marquee 20s linear infinite;
    }
    .marquee span{opacity:.9}
    .head-row{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 0;
    }
    .brand{
      display:flex;align-items:center;gap:12px;min-width:0;
    }
    .logo{
      width:46px;height:46px;border-radius:14px;
      background:var(--brand-soft);
      border:1px solid rgba(220,38,38,.25);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:var(--brand);
      overflow:hidden;
    }
    .logo img{width:100%;height:100%;object-fit:cover}

    .brand-meta{display:flex;flex-direction:column;min-width:0}
    .brand-meta .name{
      font-size:15px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .brand-meta .sub{
      font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    .head-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:var(--surface);
      font-size:12px;
      box-shadow:var(--shadow-soft);
    }
    .chip input{
      border:none;outline:none;background:transparent;
      font-weight:800;font-size:12px;color:var(--ink);
      width:200px;max-width:56vw;
    }
    .chip input::placeholder{color:var(--muted-2)}

    .btn{
      appearance:none;border:none;cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      height:38px;padding:0 14px;border-radius:999px;
      font-size:12px;font-weight:900;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
      user-select:none;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--brand-2),var(--brand));
      color:#fff;box-shadow:0 14px 30px rgba(220,38,38,.22);
    }
    .btn-primary:hover{transform:translateY(-1px)}
    .btn-outline{
      background:#fff;
      border:1px solid var(--brand);
      color:var(--brand);
      box-shadow:var(--shadow-soft);
    }
    .btn-outline:hover{transform:translateY(-1px);background:var(--brand-soft)}
    .btn-ghost{
      background:var(--surface);
      border:1px solid var(--line);
      color:var(--ink);
      box-shadow:var(--shadow-soft);
    }
    .btn:disabled{
      cursor:not-allowed;
      opacity:.55;
      box-shadow:none;
      transform:none;
    }

    .btn-gloss{
      position:relative;
      overflow:hidden;
      isolation:isolate;
    }
    .btn-gloss::after{
      content:"";
      position:absolute;
      top:-120%;
      left:-60%;
      width:60%;
      height:220%;
      background:linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.6) 45%, rgba(255,255,255,0) 70%);
      transform:translateX(-140%) rotate(20deg);
      animation:sheenSweep 3s ease-in-out infinite;
      pointer-events:none;
    }
    .btn:disabled.btn-gloss::after{opacity:0;animation:none}

    @keyframes marquee{
      0%{transform:translateX(0)}
      100%{transform:translateX(-50%)}
    }

    .hero{
      position:relative;
      padding:0;
      overflow:hidden;
    }
    .hero-media{
      position:absolute;
      inset:0;
      z-index:0;
    }
    .hero-video{
      width:100%;
      height:100%;
      object-fit:cover;
      filter:saturate(1.1) contrast(1.05);
    }
    .hero-overlay{
      position:absolute;
      inset:0;
      background:linear-gradient(120deg, rgba(10,10,12,.82), rgba(16,16,24,.55) 55%, rgba(12,12,18,.76));
      backdrop-filter:blur(4px);
    }
    .hero-noise{
      position:absolute;
      inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140' viewBox='0 0 140 140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.15'/%3E%3C/svg%3E");
      mix-blend-mode:soft-light;
      opacity:.4;
    }
    .hero-gradient{
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 15% 20%, rgba(220,38,38,.35), transparent 45%),
        radial-gradient(circle at 80% 10%, rgba(255,255,255,.12), transparent 55%);
    }
    .hero-content{
      position:relative;
      z-index:1;
      padding:var(--section) 0 42px;
    }
    .request-options{
      display:grid;
      gap:10px;
      margin:16px 0 18px;
    }
    .option-card{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--surface-soft);
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .option-card:hover{transform:translateY(-1px);box-shadow:var(--shadow-soft)}
    .option-card strong{font-size:14px}
    .option-card small{display:block;font-weight:600;color:var(--muted);font-size:11px}
    .option-card[data-disabled="true"]{opacity:.55;cursor:not-allowed}

    .cta-sheen{
      position:relative;
      overflow:hidden;
      isolation:isolate;
    }
    .cta-sheen::after{
      content:"";
      position:absolute;
      top:-120%;
      left:-60%;
      width:60%;
      height:220%;
      background:linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.6) 45%, rgba(255,255,255,0) 70%);
      transform:translateX(-140%) rotate(20deg);
      animation:sheenSweep 3s ease-in-out infinite;
      pointer-events:none;
    }
    .btn:disabled.cta-sheen::after{opacity:0;animation:none}

    .dealer-bar{
      display:none;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.88);
    }
    .dealer-bar.show{display:block}
    .dealer-bar .wrap{
      padding:12px var(--gutter);
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .dealer-meta{
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;
      font-size:12px;color:var(--muted);
    }
    .dealer-tags{display:flex;gap:8px;flex-wrap:wrap}
    .dealer-tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:var(--surface);font-size:11px;color:var(--ink);
      box-shadow:var(--shadow-soft);
    }
    .dealer-tag img{width:20px;height:20px;border-radius:999px;object-fit:cover}
    .dealer-stats{font-weight:800;color:var(--ink)}

    .hero-grid{display:grid;grid-template-columns:1.15fr .85fr;gap:22px;align-items:center}

    .hero-card{
      color:#fff;
      background:linear-gradient(140deg, rgba(15,15,20,.75), rgba(15,15,20,.55));
      border:1px solid rgba(255,255,255,.2);
      border-radius:var(--radius-lg);
      padding:30px;
      box-shadow:0 30px 70px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
      animation:heroIn .6s ease both;
    }
    .hero-card::after{
      content:"";position:absolute;right:-30px;top:-30px;width:120px;height:120px;
      background:radial-gradient(circle, rgba(239,68,68,.28), transparent 70%);
      border-radius:50%;
    }
    .hero-badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.3);
      background:rgba(255,255,255,.1);
      font-size:11px;font-weight:800;letter-spacing:.12em;text-transform:uppercase;
    }
    .hero-badge .dot{background:#22c55e}

    .eyebrow{
      display:inline-flex;align-items:center;gap:8px;
      font-size:12px;color:rgba(255,255,255,.72);
      margin-bottom:12px
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--brand)}

    h1{margin:0 0 12px;font-size:clamp(28px,3.6vw,46px);line-height:1.04}
    .lead{margin:0;color:rgba(255,255,255,.76);max-width:60ch;font-size:15px}

    .proofs{display:flex;gap:8px;flex-wrap:wrap;margin:18px 0 10px}
    .proof{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(15,15,20,.5);
      font-size:11px;font-weight:700;color:#fff;
    }
    .trust{font-size:12px;color:rgba(255,255,255,.7);margin-top:8px}

    .hero-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:18px}

    .hero-side{
      color:#fff;
      background:linear-gradient(180deg, rgba(15,15,20,.7), rgba(15,15,20,.5));
      border:1px solid rgba(255,255,255,.2);
      border-radius:var(--radius-lg);
      padding:18px;
      box-shadow:0 20px 45px rgba(0,0,0,.25);
      display:flex;flex-direction:column;gap:12px;
      animation:heroIn .6s ease .12s both;
    }
    .stat{
      border:1px solid rgba(255,255,255,.2);
      border-radius:16px;padding:12px;background:rgba(10,10,12,.5)
    }
    .stat .t{font-size:11px;color:rgba(255,255,255,.68)}
    .stat .v{font-size:18px;font-weight:900}

    .tip{
      border:1px dashed rgba(255,255,255,.3);
      background:rgba(255,255,255,.08);
      border-radius:14px;padding:12px;font-size:12px;color:rgba(255,255,255,.85)
    }

    .hero-brand{
      display:flex;align-items:center;gap:12px;margin-bottom:16px;
    }
    .hero-logo{
      width:52px;height:52px;border-radius:16px;overflow:hidden;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.12);
      display:grid;place-items:center;
    }
    .hero-logo img{width:100%;height:100%;object-fit:cover}
    .hero-name{font-size:15px;font-weight:900}
    .hero-sub{font-size:12px;color:rgba(255,255,255,.65)}

    .trust-row{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:18px
    }
    .trust-chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:rgba(15,15,20,.55);
      border:1px solid rgba(255,255,255,.22);
      font-size:11px;font-weight:700;color:#fff;
    }

    .control-bar{
      position:relative;
      margin-top:-30px;
      z-index:3;
    }
    .control-wrap{
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius:22px;
      padding:12px 14px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    .control-title{
      font-size:12px;font-weight:900;color:var(--muted);
    }

    .section{padding:24px 0 var(--section)}
    .section-head{display:flex;justify-content:space-between;gap:14px;flex-wrap:wrap}
    .section-head h2{margin:0;font-size:14px;letter-spacing:.14em;text-transform:uppercase}

    .search{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      border-radius:999px;padding:8px 12px;
      background:var(--surface);box-shadow:var(--shadow-soft)
    }
    .search input{border:none;outline:none;background:transparent;font-size:13px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin-top:14px}

    .card{
      grid-column:span 4;
      background:var(--surface);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow-soft);
      overflow:hidden;
      display:flex;flex-direction:column;
      transition:transform .12s ease, box-shadow .12s ease;
      opacity:0;
      transform:translateY(10px);
    }
    .card.show{opacity:1;transform:translateY(0);transition:transform .35s ease, opacity .35s ease, box-shadow .12s ease}
    .card:hover{transform:translateY(-4px);box-shadow:0 30px 60px rgba(15,23,42,.16)}

    .media{aspect-ratio:16/10;background:#f1f1f1;position:relative;overflow:hidden}
    .media img{width:100%;height:100%;object-fit:cover;transition:transform .4s ease}
    .media::after{
      content:"";position:absolute;inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,.0) 55%, rgba(0,0,0,.3));
      opacity:.7;
    }
    .card:hover .media img{transform:scale(1.05);transition:transform .4s ease}

    .badge{
      position:absolute;top:10px;left:10px;
      padding:6px 10px;border-radius:999px;
      font-size:10px;font-weight:900;text-transform:uppercase;
      background:#fff;border:1px solid var(--line)
    }
    .badge.available{color:#166534;background:#dcfce7;border-color:#bbf7d0}
    .badge.pending{color:#92400e;background:#fef3c7;border-color:#fde68a}
    .badge.sold{color:#374151;background:#e5e7eb;border-color:#d1d5db}
    .badge.sale{color:#9a3412;background:#ffedd5;border-color:#fdba74}
    .badge.negotiable{color:#1d4ed8;background:#dbeafe;border-color:#93c5fd}

    .card-body{padding:14px;display:flex;flex-direction:column;gap:10px;flex:1}
    .veh-title{margin:0;font-size:16px;font-weight:900;letter-spacing:.02em}
    .veh-sub{font-size:12px;color:var(--muted)}
    .price{font-size:18px;font-weight:950;color:var(--brand)}

    .specs{display:flex;flex-wrap:wrap;gap:6px}
    .spec{
      font-size:11px;padding:5px 9px;border-radius:999px;
      border:1px solid var(--line);background:var(--surface-soft)
    }

    .card-actions{margin-top:auto;display:flex;flex-direction:column;gap:8px}

    .empty-state{
      grid-column:1/-1;
      border:1px dashed rgba(0,0,0,.15);
      background:rgba(255,255,255,.75);
      border-radius:18px;padding:18px;color:var(--muted);
    }
    .empty-state strong{color:var(--ink)}

    .skeleton-card{pointer-events:none}
    .skeleton-block{height:12px;background:#e5e7eb;border-radius:10px;position:relative;overflow:hidden}
    .skeleton-block::after{
      content:"";position:absolute;inset:0;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.6), transparent);
      transform:translateX(-100%);
      animation:shimmer 1.2s infinite;
    }

    @keyframes shimmer{
      100%{transform:translateX(100%)}
    }

    @keyframes heroIn{
      from{opacity:0;transform:translateY(12px)}
      to{opacity:1;transform:translateY(0)}
    }

    @keyframes sheenSweep{
      0%{transform:translateX(-140%) rotate(20deg)}
      55%{transform:translateX(140%) rotate(20deg)}
      100%{transform:translateX(140%) rotate(20deg)}
    }

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:50;padding:18px}
    .overlay.show{display:grid}

    .modal{
      width:min(920px,100%);
      background:var(--surface);
      border-radius:var(--radius-lg);
      border:1px solid var(--line);
      box-shadow:0 40px 90px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .modal-head{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-weight:900;font-size:15px}
    .modal-body{padding:16px}
    .modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}

    .modal-media{
      border-radius:18px;border:1px solid var(--line);overflow:hidden;min-height:240px;background:#f1f1f1
    }
    .modal-media img{width:100%;height:100%;object-fit:cover}
    .modal-media video{width:100%;height:100%;object-fit:cover;background:#000}

    .modal-copy{display:flex;flex-direction:column;gap:10px}
    .next-steps{margin:0;padding-left:18px;color:var(--muted);font-size:12px}
    .next-steps li{margin-bottom:6px}

    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .form-field{display:flex;flex-direction:column;gap:6px}
    .form-field label{font-size:11px;color:var(--muted);font-weight:700}
    .input,.textarea,.select{
      border-radius:14px;border:1px solid var(--line);
      background:var(--surface);padding:10px 12px;font-size:13px;
      outline:none;transition:box-shadow .12s ease, border-color .12s ease
    }
    .input:focus,.textarea:focus,.select:focus{border-color:rgba(220,38,38,.45);box-shadow:0 0 0 4px rgba(220,38,38,.12)}
    .textarea{min-height:90px;resize:vertical}

    .modal-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}

    .success-box{
      display:none;
      border:1px solid rgba(22,163,74,.3);
      background:rgba(220,252,231,.7);
      border-radius:14px;padding:12px;font-size:12px;color:#14532d
    }
    .success-box.show{display:block}

    footer{border-top:1px solid var(--line);padding:28px 0 40px;color:var(--muted);font-size:12px}

    #toast{
      position:fixed;top:18px;right:18px;z-index:80;
      display:none;align-items:center;gap:10px;
      padding:12px 14px;border-radius:14px;
      background:rgba(255,255,255,.95);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      font-size:12px;font-weight:700
    }
    #toast.show{display:flex}
    #toast.success{border-color:rgba(22,163,74,.35);color:#166534}
    #toast.error{border-color:rgba(239,68,68,.35);color:#991b1b}
    #toastDot{width:8px;height:8px;border-radius:999px;background:var(--brand)}

    @media(max-width:980px){
      header{position:relative}
      .hero-grid{grid-template-columns:1fr}
      .control-bar{margin-top:-18px}
      .card{grid-column:span 6}
      .modal-grid{grid-template-columns:1fr}
    }
    @media(max-width:640px){
      .hero-actions .btn{width:100%}
      .control-wrap{flex-direction:column;align-items:stretch}
      .chip{width:100%}
      .head-row{flex-direction:column;align-items:flex-start}
      .head-actions{width:100%;justify-content:flex-start}
      .card{grid-column:span 12}
      .form-grid{grid-template-columns:1fr}
    }

    @media (prefers-reduced-motion: reduce){
      *, *::before, *::after{animation-duration:0.01ms !important;animation-iteration-count:1 !important;transition-duration:0.01ms !important;scroll-behavior:auto !important}
      .cta-sheen::after{animation:none !important}
    }
  </style>
</head>
<body>

<div class="marquee" aria-hidden="true">
  <div class="wrap">
    <div class="marquee-track">
      <span>Live Inventory ‚Ä¢ Real Availability ‚Ä¢ Book Viewings Fast</span>
      <span>No more ‚Äústill available?‚Äù messages</span>
      <span>Real-time updates ‚Ä¢ WhatsApp routing ‚Ä¢ Cleaner sales flow</span>
      <span>Live Inventory ‚Ä¢ Real Availability ‚Ä¢ Book Viewings Fast</span>
      <span>No more ‚Äústill available?‚Äù messages</span>
      <span>Real-time updates ‚Ä¢ WhatsApp routing ‚Ä¢ Cleaner sales flow</span>
    </div>
  </div>
</div>

<header>
  <div class="wrap">
    <div class="head-row">
      <div class="brand">
        <div class="logo">
          <img id="dealerLogoImg" src="https://res.cloudinary.com/dd8pjjxsm/image/upload/v1770298701/ChatGPT_Image_Sep_6_2025_08_27_53_AM_raorxf.png" alt="Storefront logo" />
        </div>
        <div class="brand-meta">
          <div class="name" id="dealerName">Dealer Concierge</div>
          <div class="sub" id="dealerSub">Verified availability ¬∑ Fast response</div>
        </div>
      </div>
      <div class="head-actions">
        <button id="scrollBtn" class="btn btn-primary btn-gloss">Browse vehicles</button>
        <a class="btn btn-outline" href="/landing">Become a Dealer</a>
        <button class="btn btn-ghost" id="headerSupportBtn" type="button">Buyer support</button>
      </div>
    </div>
  </div>
</header>

<section class="dealer-bar" id="dealerBar">
  <div class="wrap">
    <div class="dealer-meta">
      <span class="dealer-stats" id="dealerSummary">Dealers loaded</span>
      <span id="dealerStats">0 vehicles</span>
      <span id="lastRefresh">Last refreshed ‚Äî</span>
    </div>
    <div class="dealer-tags" id="dealerTags"></div>
  </div>
</section>

<main>
  <section class="hero">
    <div class="hero-media" aria-hidden="true">
      <video class="hero-video" autoplay loop muted playsinline poster="https://res.cloudinary.com/dd8pjjxsm/image/upload/v1768193442/mediaexclusive/dealers/0000/vehicles/VEH-0069/qbu8lvupz54ufudhcnv6.jpg">
        <source src="https://res.cloudinary.com/dd8pjjxsm/video/upload/v1768788528/From_KlickPin_CF_Ford_WT_V6%E1%84%8B%E1%85%A6_%E1%84%8B%E1%85%B5%E1%86%BB%E1%84%82%E1%85%B3%E1%86%AB_Travis_Lee%E1%84%82%E1%85%B5%E1%86%B7%E1%84%8B%E1%85%B4_%E1%84%91%E1%85%B5%E1%86%AB___%E1%84%80%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AF_%E1%84%83%E1%85%B5%E1%84%8C%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%AB_%E1%84%86%E1%85%A9%E1%84%89%E1%85%A7%E1%86%AB_%E1%84%80%E1%85%B3%E1%84%85%E1%85%A2%E1%84%91%E1%85%B5%E1%86%A8_%E1%84%8B%E1%85%B0%E1%86%B8%E1%84%83%E1%85%B5%E1%84%8C%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%ABMoon_Choi_avatar_link_fuy9ir.mp4" type="video/mp4" />
        <source src="assets/hero.mp4" type="video/mp4" />
      </video>
      <div class="hero-gradient"></div>
      <div class="hero-overlay"></div>
      <div class="hero-noise"></div>
    </div>
    <div class="hero-content">
      <div class="wrap">
        <div class="hero-grid">
          <div class="hero-card" id="heroCard">
            <div class="hero-brand">
              <div class="hero-logo">
                <img id="heroLogoImg" src="https://res.cloudinary.com/dd8pjjxsm/image/upload/v1770298701/ChatGPT_Image_Sep_6_2025_08_27_53_AM_raorxf.png" alt="Dealer logo" />
              </div>
              <div>
                <div class="hero-name" id="heroDealerName">Dealer Concierge</div>
                <div class="hero-sub" id="heroDealerSub">Curated vehicles ¬∑ Verified availability</div>
                <div class="hero-badge" id="verifiedBadge" style="margin-top:8px;display:none"><span class="dot"></span> Verified Dealer</div>
              </div>
            </div>
            <div class="eyebrow"><span class="dot"></span> Premium dealer experience</div>
            <h1 id="heroTitle">Curated vehicles. Real availability. Book a viewing in minutes.</h1>
            <p class="lead" id="heroLead">
              No ghost listings. No wasted trips. Only vehicles that are ready to show‚Äîmanaged by verified dealers.
            </p>
            <div class="proofs">
              <span class="proof">Verified availability</span>
              <span class="proof">Fast response</span>
              <span class="proof">Secure requests</span>
            </div>
            <div class="trust-row">
              <span class="trust-chip">‚úî Verified availability</span>
              <span class="trust-chip">‚ö° Fast response</span>
              <span class="trust-chip">üîí Secure requests</span>
            </div>
            <div class="hero-actions">
              <button class="btn btn-primary btn-gloss" id="heroPrimaryCta">View available vehicles</button>
              <button class="btn btn-ghost" id="howBtn">How it works</button>
            </div>
          </div>

          <aside class="hero-side">
            <div class="stat">
              <div class="t">Vehicles available</div>
              <div class="v" id="kpiLive">‚Äì</div>
            </div>
            <div class="stat">
              <div class="t">Dealer ID</div>
              <div class="v" id="kpiDealer">‚Äì</div>
            </div>
            <div class="tip" id="rotatingTip">
              Tip: Use a live video viewing before visiting in person.
            </div>
          </aside>
        </div>
      </div>
    </div>
  </section>

  <section class="control-bar">
    <div class="wrap">
      <div class="control-wrap">
        <div class="control-title">Dealer ID</div>
        <div class="chip" style="flex:1 1 280px">
          <span>Dealer ID</span>
          <input id="dealerIdInput" placeholder="DEALER-0001" />
        </div>
        <div class="search" style="flex:1 1 240px">
          <span>‚åï</span>
          <input id="searchInput" placeholder="Search make, model, year‚Ä¶" />
        </div>
        <button id="loadBtn" class="btn btn-primary btn-gloss">Load vehicles</button>
        <button id="resetBtn" class="btn btn-ghost">Reset</button>
      </div>
    </div>
  </section>

  <section class="section" id="inventory">
    <div class="wrap">
      <div class="section-head">
        <h2>Available Vehicles</h2>
        <div class="trust">Real-time availability ¬∑ Updated on refresh</div>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </section>
</main>

<footer>
  <div class="wrap">
    Curated vehicles for serious buyers ¬∑ Built by Pytch LLC ¬© <span id="year"></span>
  </div>
</footer>

<div id="toast"><span id="toastDot"></span><span id="toastMsg"></span></div>

<div class="overlay" id="modalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-head">
      <div class="modal-title" id="modalTitle">Book a viewing</div>
      <button class="btn btn-ghost" id="modalClose" type="button">Close</button>
    </div>
    <div class="modal-body">
      <div class="modal-grid">
        <div class="modal-media">
          <img id="modalImage" alt="Vehicle preview" />
          <video id="modalVideo" class="modal-video" controls playsinline style="display:none"></video>
        </div>
        <div class="modal-copy">
          <div>
            <div style="font-weight:900;font-size:15px" id="modalVehicle">Vehicle</div>
            <div style="font-size:12px;color:var(--muted)" id="modalPrice">Price on request</div>
          </div>
          <ul class="next-steps">
            <li>Your request goes straight to the dealer concierge.</li>
            <li>They confirm availability and a viewing window.</li>
            <li>No spam ‚Äî just a fast confirmation.</li>
          </ul>
          <div class="request-options" id="requestOptions">
            <button class="option-card" type="button" data-type="whatsapp" id="whatsAppOption">
              <div>
                <strong>WhatsApp Chat Request</strong>
                <small>Instant message to this dealer</small>
              </div>
              <span>‚Üó</span>
            </button>
            <button class="option-card" type="button" data-type="live_video">
              <div>
                <strong>Live Video Viewing</strong>
                <small>Book a real-time walkaround</small>
              </div>
              <span>+</span>
            </button>
            <button class="option-card" type="button" data-type="walk_in">
              <div>
                <strong>Book a Walk-In</strong>
                <small>Reserve an in-person slot</small>
              </div>
              <span>+</span>
            </button>
          </div>
          <form id="requestForm">
            <div class="form-grid">
              <div class="form-field">
                <label for="reqName">Name *</label>
                <input class="input" id="reqName" name="name" required placeholder="Alex Morgan" />
              </div>
              <div class="form-field">
                <label for="reqPhone">Phone *</label>
                <input class="input" id="reqPhone" name="phone" required placeholder="876 555 0123" />
              </div>
              <div class="form-field">
                <label for="reqEmail">Email</label>
                <input class="input" id="reqEmail" name="email" type="email" placeholder="you@email.com" />
              </div>
              <input type="hidden" id="reqType" name="type" value="live_video" />
              <div class="form-field">
                <label for="reqDate">Preferred date</label>
                <input class="input" id="reqDate" name="date" type="date" />
              </div>
              <div class="form-field">
                <label for="reqTime">Preferred time</label>
                <input class="input" id="reqTime" name="time" type="time" />
              </div>
            </div>
            <div class="form-field" style="margin-top:10px">
              <label for="reqNotes">Notes</label>
              <textarea class="textarea" id="reqNotes" name="notes" placeholder="Any detail to help the dealer confirm faster."></textarea>
            </div>
            <div class="modal-actions">
              <button class="btn btn-primary" id="submitBtn" type="submit">Send request</button>
              <div class="success-box" id="modalSuccess">Request sent. Dealer will confirm within minutes.</div>
            </div>
            <div id="modalError" style="font-size:12px;color:#991b1b;margin-top:8px"></div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const API_BASE = "";
  const $ = (id) => document.getElementById(id);
  const $$ = (selector, root = document) => Array.from(root.querySelectorAll(selector));

  const ui = {
    dealerLogoImg: $("dealerLogoImg"),
    dealerName: $("dealerName"),
    dealerSub: $("dealerSub"),
    heroLogoImg: $("heroLogoImg"),
    heroDealerName: $("heroDealerName"),
    heroDealerSub: $("heroDealerSub"),
    verifiedBadge: $("verifiedBadge"),

    dealerIdInput: $("dealerIdInput"),
    loadBtn: $("loadBtn"),
    resetBtn: $("resetBtn"),
    headerSupportBtn: $("headerSupportBtn"),

    heroTitle: $("heroTitle"),
    heroLead: $("heroLead"),
    heroCard: $("heroCard"),
    kpiLive: $("kpiLive"),
    kpiDealer: $("kpiDealer"),
    rotatingTip: $("rotatingTip"),

    scrollBtn: $("scrollBtn"),
    heroPrimaryCta: $("heroPrimaryCta"),
    howBtn: $("howBtn"),

    searchInput: $("searchInput"),
    grid: $("grid"),

    dealerBar: $("dealerBar"),
    dealerSummary: $("dealerSummary"),
    dealerStats: $("dealerStats"),
    dealerTags: $("dealerTags"),
    lastRefresh: $("lastRefresh"),

    toast: $("toast"),
    toastMsg: $("toastMsg"),
    toastDot: $("toastDot"),

    modalOverlay: $("modalOverlay"),
    modalClose: $("modalClose"),
    modalTitle: $("modalTitle"),
    modalImage: $("modalImage"),
    modalVideo: $("modalVideo"),
    modalVehicle: $("modalVehicle"),
    modalPrice: $("modalPrice"),
    requestForm: $("requestForm"),
    submitBtn: $("submitBtn"),
    modalSuccess: $("modalSuccess"),
    modalError: $("modalError"),
    requestOptions: $("requestOptions"),
    whatsAppOption: $("whatsAppOption"),

    reqName: $("reqName"),
    reqPhone: $("reqPhone"),
    reqEmail: $("reqEmail"),
    reqDate: $("reqDate"),
    reqTime: $("reqTime"),
    reqNotes: $("reqNotes"),
    reqType: $("reqType"),

    year: $("year"),
  };

  const state = {
    dealerIds: [],
    dealers: [],
    dealerProfiles: {},
    vehicles: [],
    filtered: [],
    tipIndex: 0,
    activeVehicle: null,
    lastRefreshed: null,
  };

  const tips = [
    "Tip: Live video viewings save you wasted trips.",
    "Tip: Confirm availability before traveling.",
    "Tip: WhatsApp chat gets the fastest response.",
    "Tip: Ask for service history and VIN upfront.",
  ];

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function isValidDealerId(v){
    return /^[a-zA-Z0-9_-]{3,40}$/.test(String(v || "").trim());
  }

  function parseDealerIds(input){
    const raw = String(input || "").split(",").map((part) => part.trim()).filter(Boolean);
    const ids = [];
    for(const item of raw){
      if(!item) continue;
      const candidate = item.replace(/\s+/g, "");
      if(!isValidDealerId(candidate)) continue;
      if(!ids.includes(candidate)) ids.push(candidate);
      if(ids.length >= 1) break;
    }
    return ids;
  }

  function money(n){
    const v = Number(n);
    if(!Number.isFinite(v) || v <= 0) return "Price on request";
    return "J$ " + v.toLocaleString(undefined,{ maximumFractionDigits:0 });
  }

  function normalizeStatus(s){
    const v = String(s || "").trim().toLowerCase();
    if(!v) return { label:"Available", cls:"available" };
    if(["available","in stock","instock","in_stock"].includes(v)) return { label:"Available", cls:"available" };
    if(["pending","reserved"].includes(v)) return { label:"Pending", cls:"pending" };
    if(["sold","archived"].includes(v)) return { label:(v === "archived" ? "Archived" : "Sold"), cls:"sold" };
    if(v.includes("sale") || v.includes("deal")) return { label:"On Sale", cls:"sale" };
    if(v.includes("negotiable")) return { label:"Negotiable", cls:"negotiable" };
    return { label:s, cls:"pending" };
  }

  function parseImageUrls(raw){
    if(!raw) return [];
    if(Array.isArray(raw)){
      return raw.map((item) => {
        if(typeof item === "string") return item;
        if(item && typeof item === "object") return item.url || item.src || "";
        return "";
      }).filter(Boolean);
    }
    if(typeof raw === "string"){
      const trimmed = raw.trim();
      if(trimmed.startsWith("[")){
        try{
          const parsed = JSON.parse(trimmed);
          return parseImageUrls(parsed);
        }catch(err){
          return trimmed.split(/[\s,]+/).filter(Boolean);
        }
      }
      return trimmed.split(/[\s,]+/).filter(Boolean);
    }
    return [];
  }

  function pickImageUrl(vehicle){
    const direct =
      vehicle?.heroImageUrl ||
      vehicle?.hero_image_url ||
      vehicle?.cloudinaryImageUrls ||
      vehicle?.cloudinaryImageUrl ||
      vehicle?.imageUrl ||
      vehicle?.logoUrl;
    const parsed = parseImageUrls(direct);
    if(parsed.length) return parsed[0];

    const alt = vehicle?.cloudinary_image_urls || vehicle?.cloudinary_image_url;
    const parsedAlt = parseImageUrls(alt);
    if(parsedAlt.length) return parsedAlt[0];

    const att = vehicle?.images || vehicle?.["Main Photo"] || vehicle?.["Gallery Photos"] || vehicle?.["Logo"] || [];
    const parsedAtt = parseImageUrls(att);
    return parsedAtt[0] || "";
  }

  function normalizeVehicle(v){
    const year = v.year || v.Year || v.year_built || v["Year"] || "";
    const make = v.make || v.Make || "";
    const model = v.model || v.Model || "";
    const title = v.title || v.Title || [year, make, model].filter(Boolean).join(" ") || "Vehicle";
    const dealerId = v.dealerId || v.dealer_id || v["Dealer ID"] || v["dealerId"] || state.dealerIds[0] || "";
    const availability = v.availability ?? v.available ?? v.is_available;
    const status = v.status || v.Status || v.availability_status || v.state || "available";

    return {
      vehicleId: v.vehicleId || v.vehicle_id || v["Vehicle ID"] || v["vehicleId"] || "",
      dealerId,
      title,
      year,
      make,
      model,
      price: v.price || v.Price || 0,
      status,
      availability,
      imageUrl: pickImageUrl(v),
      heroVideoUrl: v.heroVideoUrl || v.hero_video_url || v.cloudinaryVideoUrl || v.cloudinary_video_url || "",
      mileage: v.mileage || v.Mileage || v.odometer || "",
      transmission: v.transmission || v.Transmission || "",
      fuel: v.fuel || v.fuelType || v["Fuel Type"] || "",
      color: v.color || v.Color || "",
      bodyType: v.bodyType || v.body_type || v["Body Type"] || "",
      raw: v,
    };
  }

  function isPublicVehicle(v){
    if(v.availability === false) return false;
    if(String(v.status || "").toLowerCase() === "archived") return false;
    return true;
  }

  function normalizeDealerProfile(profile){
    const dealerId = profile?.dealerId || profile?.dealer_id || "";
    return {
      dealerId,
      dealerName: profile?.dealerName || profile?.name || "",
      status: profile?.status || "",
      logoUrl: profile?.logoUrl || profile?.logo || "",
      whatsappNumber: profile?.whatsappNumber || profile?.whatsapp_number || profile?.whatsapp || profile?.whatsappPhone || profile?.whatsapp_phone || profile?.phoneWhatsapp || profile?.phone_whatsapp || "",
      whatsappDefaultMessage: profile?.whatsappDefaultMessage || profile?.whatsapp_default_message || profile?.whatsappMessage || profile?.whatsapp_message || profile?.defaultMessage || "",
      raw: profile,
    };
  }

  function getDealerProfile(dealerId){
    return state.dealerProfiles[dealerId] || null;
  }

  function sanitizeWhatsAppNumber(raw){
    return String(raw || "").replace(/\D/g, "");
  }

  function buildWhatsAppMessage(vehicle, dealerProfile){
    const lines = [];
    const vehicleId = vehicle?.vehicleId || "‚Äî";
    lines.push(`Hi! I'm interested in Vehicle ID: ${vehicleId}`);

    const defaultMessage = dealerProfile?.whatsappDefaultMessage;
    if(defaultMessage) lines.push(defaultMessage);

    const dealerName = dealerProfile?.dealerName || dealerProfile?.name;
    if(dealerName) lines.push(`Dealer: ${dealerName}`);
    if(vehicle?.title) lines.push(`Vehicle: ${vehicle.title}`);

    const priceText = money(vehicle?.price);
    if(priceText && priceText !== "Price on request") lines.push(`Price: ${priceText}`);
    if(location?.href) lines.push(`Listing: ${location.href}`);

    return lines.filter(Boolean).join("\n");
  }

  function setBranding(){
    const dealerIds = state.dealerIds;
    const dealers = state.dealers;
    const primary = dealers.length === 1 ? dealers[0] : null;

    ui.kpiDealer.textContent = dealerIds.length ? dealerIds.join(", ") : "‚Äì";

    if(!dealerIds.length){
      ui.verifiedBadge.style.display = "none";
      ui.dealerName.textContent = "Dealer Concierge";
      ui.dealerSub.textContent = "Verified availability ¬∑ Fast response";
      ui.heroDealerName.textContent = "Dealer Concierge";
      ui.heroDealerSub.textContent = "Curated vehicles ¬∑ Verified availability";
      ui.heroTitle.textContent = "Curated vehicles. Real availability. Book a viewing in minutes.";
      ui.heroLead.textContent = "Enter a Dealer ID to see what‚Äôs ready to drive today‚Äîno ghost listings, just verified availability.";
      ui.dealerLogoImg.src = "https://res.cloudinary.com/dd8pjjxsm/image/upload/v1770298701/ChatGPT_Image_Sep_6_2025_08_27_53_AM_raorxf.png";
      ui.heroLogoImg.src = ui.dealerLogoImg.src;
      return;
    }

    if(primary){
      const name = primary.dealerName || primary.name || primary.dealerId || dealerIds[0];
      ui.verifiedBadge.style.display = "inline-flex";
      ui.dealerName.textContent = name;
      ui.dealerSub.textContent = (primary.status ? ("Status: " + primary.status) : "Verified dealer") + " ¬∑ Concierge viewing";
      ui.heroDealerName.textContent = name;
      ui.heroDealerSub.textContent = "Verified dealer ¬∑ Priority responses";
      ui.heroTitle.textContent = "Explore " + name + "‚Äôs available vehicles.";
      ui.heroLead.textContent = "Serious buyers only ‚Äî real-time availability, premium presentation, and fast booking.";
      const logoUrl = primary.logoUrl || primary.logo;
      if(logoUrl && String(logoUrl).startsWith("http")){
        ui.dealerLogoImg.src = logoUrl;
        ui.dealerLogoImg.alt = name;
        ui.heroLogoImg.src = logoUrl;
        ui.heroLogoImg.alt = name;
      }
    } else {
      ui.verifiedBadge.style.display = "none";
      ui.dealerName.textContent = "Dealer Storefront";
      ui.dealerSub.textContent = "Enter a Dealer ID to view live inventory";
      ui.heroDealerName.textContent = "Dealer Storefront";
      ui.heroDealerSub.textContent = "Public listings ¬∑ Verified availability";
      ui.heroTitle.textContent = "Enter a Dealer ID to unlock live inventory.";
      ui.heroLead.textContent = "Each storefront is dealer-specific. Type a Dealer ID to browse and book viewings.";
      ui.dealerLogoImg.src = "https://res.cloudinary.com/dd8pjjxsm/image/upload/v1770298701/ChatGPT_Image_Sep_6_2025_08_27_53_AM_raorxf.png";
      ui.heroLogoImg.src = ui.dealerLogoImg.src;
    }
  }

  function updateDealerBar(){
    if(!state.dealerIds.length){
      ui.dealerBar.classList.remove("show");
      ui.dealerTags.innerHTML = "";
      return;
    }
    ui.dealerBar.classList.add("show");
    ui.dealerSummary.textContent = "Dealer loaded";
    ui.dealerStats.textContent = state.vehicles.length + " vehicles";
    ui.lastRefresh.textContent = state.lastRefreshed ? "Last refreshed " + state.lastRefreshed : "Last refreshed ‚Äî";

    ui.dealerTags.innerHTML = "";
    const dealerMap = new Map(state.dealers.map((d) => [d.dealerId || d.dealer_id, d]));
    state.dealerIds.forEach((id) => {
      const dealer = dealerMap.get(id) || {};
      const name = dealer.dealerName || dealer.name || id;
      const tag = document.createElement("div");
      tag.className = "dealer-tag";
      const logo = dealer.logoUrl || dealer.logo;
      tag.innerHTML = `${logo ? `<img src="${esc(logo)}" alt="${esc(name)}" />` : ``}<span>${esc(name)}</span>`;
      ui.dealerTags.appendChild(tag);
    });
  }

  function setLoading(){
    ui.grid.innerHTML = "";
    for(let i=0;i<6;i++){
      const card = document.createElement("div");
      card.className = "card show skeleton-card";
      card.innerHTML = `
        <div class="media"></div>
        <div class="card-body">
          <div class="skeleton-block" style="height:14px"></div>
          <div class="skeleton-block" style="height:12px;width:70%;margin-top:10px"></div>
          <div class="skeleton-block" style="height:16px;width:55%;margin-top:10px"></div>
        </div>
      `;
      ui.grid.appendChild(card);
    }
  }

  function renderEmptyState(message){
    ui.grid.innerHTML = `
      <div class="empty-state">
        <div style="font-weight:900;margin-bottom:6px"><strong>${esc(message.title)}</strong></div>
        ${esc(message.body)}
      </div>
    `;
  }

  function render(){
    const list = state.filtered;
    ui.grid.innerHTML = "";
    ui.kpiLive.textContent = String(list.length || 0);

    if(!state.dealerIds.length){
      renderEmptyState({
        title:"Enter a dealer ID to view vehicles",
        body:"Paste the dealer ID from your link to load verified inventory. Example: DEALER-0001.",
      });
      return;
    }

    if(!list.length){
      renderEmptyState({
        title:"No vehicles found",
        body:"Try a different search term or confirm the dealer ID is correct.",
      });
      return;
    }

    list.forEach((v, index)=>{
      const title = v.title || "Vehicle";
      const sub = [v.year, v.make, v.model].filter(Boolean).join(" ¬∑ ") || v.bodyType || "";
      const price = money(v.price);
      const img = v.imageUrl;
      const st = normalizeStatus(v.status);
      const vehicleId = v.vehicleId || "";
      const dealerId = v.dealerId || state.dealerIds[0] || "";

      const specs = [
        v.mileage ? (Number(v.mileage).toLocaleString() + " km") : "",
        v.transmission || "",
        v.fuel || "",
        v.color || "",
      ].filter(Boolean).slice(0,4);

      const card = document.createElement("div");
      card.className = "card";
      card.style.transitionDelay = (index * 40) + "ms";
      card.innerHTML = `
        <div class="media">
          ${img ? `<img src="${esc(img)}" alt="${esc(title)}" loading="lazy" />` : ``}
          <div class="badge ${esc(st.cls)}">${esc(st.label)}</div>
        </div>
        <div class="card-body">
          <div>
            <div class="veh-title">${esc(title)}</div>
            <div class="veh-sub">${esc(sub)}</div>
          </div>
          <div class="price">${esc(price)}</div>
          <div class="specs">${specs.map(p=>`<span class="spec">${esc(p)}</span>`).join("")}</div>
        <div class="card-actions">
          <button class="btn btn-primary btn-gloss" style="width:100%" type="button">Make Request</button>
        </div>
      </div>
      `;

      const vehiclePayload = { ...v, vehicleId, dealerId };
      card.querySelector("button").addEventListener("click", ()=>{
        openModal(vehiclePayload);
      });

      ui.grid.appendChild(card);
      requestAnimationFrame(() => card.classList.add("show"));
    });
  }

  function applySearch(){
    const q = String(ui.searchInput.value || "").trim().toLowerCase();
    if(!q){
      state.filtered = [...state.vehicles];
      render();
      return;
    }

    state.filtered = state.vehicles.filter(v => {
      const blob = [v.vehicleId, v.title, v.make, v.model, v.year, v.status, v.color].filter(Boolean).join(" ").toLowerCase();
      return blob.includes(q);
    });

    render();
  }

  async function safeJson(res){
    try{ return await res.json(); }catch{ return null; }
  }

  async function fetchOk(url, opts){
    const res = await fetch(url, { ...opts, headers:{ "Accept":"application/json", ...(opts?.headers||{}) } });
    const data = await safeJson(res);
    if(!res.ok || !data?.ok){
      throw new Error(data?.error || ("Request failed (" + res.status + ")"));
    }
    return data;
  }

  async function loadDealerProfile(dealerId){
    try{
      const data = await fetchOk(API_BASE + "/api/public/dealer/" + encodeURIComponent(dealerId), { method:"GET" });
      return data.dealer;
    }catch(err){
      console.warn("Dealer profile load failed", err);
      return null;
    }
  }

  async function getDealerProfileOrLoad(dealerId){
    if(!dealerId) return null;
    if(state.dealerProfiles[dealerId]) return state.dealerProfiles[dealerId];
    const profile = await loadDealerProfile(dealerId);
    if(profile){
      const normalized = normalizeDealerProfile(profile);
      state.dealerProfiles[dealerId] = normalized;
      return normalized;
    }
    return null;
  }

  async function ensureDealerProfiles(dealerIds){
    const tasks = dealerIds.map((dealerId) => getDealerProfileOrLoad(dealerId));
    await Promise.all(tasks);
  }

  async function loadVehiclesForDealer(dealerId){
    const data = await fetchOk(API_BASE + "/api/public/dealer/" + encodeURIComponent(dealerId) + "/vehicles", { method:"GET" });
    return data;
  }

  async function loadVehiclesForDealers(dealerIds){
    const data = await fetchOk(API_BASE + "/api/public/vehicles?dealerIds=" + dealerIds.map(encodeURIComponent).join(","), { method:"GET" });
    return data;
  }

  async function createRequest(payload, dealerId){
    const data = await fetchOk(API_BASE + "/api/public/dealer/" + encodeURIComponent(dealerId) + "/requests", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    return data;
  }

  function setDealerInUrl(dealerIds){
    const clean = dealerIds[0] || "";
    const next = clean ? ("/" + encodeURIComponent(clean)) : "/storefront/";
    history.replaceState({}, "", next);
  }

  function parseDealerFromPath(){
    const parts = String(location.pathname || "").split("/").filter(Boolean);
    if(!parts.length) return "";
    if(parts[0].toLowerCase() === "storefront" && parts[1]) return decodeURIComponent(parts[1]);
    if(parts[0] && parts[0].toLowerCase() !== "storefront") return decodeURIComponent(parts[0]);
    return "";
  }

  function parseDealerFromQuery(){
    const params = new URLSearchParams(window.location.search);
    const dealerId = params.get("dealerId");
    return dealerId ? dealerId.trim() : "";
  }

  function toast(message, type="info"){
    ui.toastMsg.textContent = message;
    ui.toast.className = "";
    ui.toast.classList.add("show");
    if(type === "success") ui.toast.classList.add("success");
    if(type === "error") ui.toast.classList.add("error");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>ui.toast.classList.remove("show"), 3200);
  }

  function openWhatsApp(vehicle, digits, dealerProfile){
    if(!digits){
      toast("WhatsApp unavailable for this dealer.", "error");
      return;
    }
    const message = buildWhatsAppMessage(vehicle, dealerProfile);
    const url = "https://wa.me/" + digits + "?text=" + encodeURIComponent(message);
    window.open(url, "_blank", "noopener");
  }

  function openModal(vehicle){
    state.activeVehicle = vehicle;
    const dealerProfile = getDealerProfile(vehicle.dealerId);
    const whatsappDigits = sanitizeWhatsAppNumber(dealerProfile?.whatsappNumber);
    const whatsappAvailable = Boolean(whatsappDigits);

    ui.modalError.textContent = "";
    ui.modalSuccess.classList.remove("show");
    ui.submitBtn.disabled = false;
    ui.submitBtn.textContent = "Send request";

    ui.modalVehicle.textContent = vehicle.title || "Vehicle";
    ui.modalPrice.textContent = money(vehicle.price);
    const fallbackImage = "https://res.cloudinary.com/dd8pjjxsm/image/upload/v1770298701/ChatGPT_Image_Sep_6_2025_08_27_53_AM_raorxf.png";
    ui.modalImage.src = vehicle.imageUrl || fallbackImage;
    const heroVideo = vehicle.heroVideoUrl || "";
    if(heroVideo){
      ui.modalVideo.src = heroVideo;
      ui.modalVideo.style.display = "block";
      ui.modalImage.style.display = "none";
    }else{
      ui.modalVideo.removeAttribute("src");
      ui.modalVideo.style.display = "none";
      ui.modalImage.style.display = "block";
    }
    ui.modalTitle.textContent = "Book a viewing";

    ui.requestForm.reset();
    ui.reqType.value = "live_video";
    ui.whatsAppOption.setAttribute("data-disabled", whatsappAvailable ? "false" : "true");

    ui.modalOverlay.classList.add("show");
    ui.modalOverlay.setAttribute("aria-hidden", "false");
  }

  function closeModal(){
    ui.modalOverlay.classList.remove("show");
    ui.modalOverlay.setAttribute("aria-hidden", "true");
  }

  async function submitRequest(event){
    event.preventDefault();
    ui.modalError.textContent = "";
    ui.modalSuccess.classList.remove("show");

    const active = state.activeVehicle;
    if(!active){
      ui.modalError.textContent = "No vehicle selected.";
      return;
    }

    const payload = {
      requestType: ui.reqType.value || "walk_in",
      vehicleId: active.vehicleId,
      dealerId: active.dealerId,
      customerName: ui.reqName.value.trim(),
      phone: ui.reqPhone.value.trim(),
      email: ui.reqEmail.value.trim(),
      preferredDate: ui.reqDate.value,
      preferredTime: ui.reqTime.value,
      notes: ui.reqNotes.value.trim(),
    };

    if(!payload.customerName){
      ui.modalError.textContent = "Name is required.";
      return;
    }
    if(!payload.phone){
      ui.modalError.textContent = "Phone number is required.";
      return;
    }

    ui.submitBtn.disabled = true;
    ui.submitBtn.textContent = "Sending‚Ä¶";

    try{
      await createRequest(payload, active.dealerId || state.dealerIds[0]);
      ui.modalSuccess.classList.add("show");
      toast("Request sent. Dealer will confirm shortly.", "success");
      ui.submitBtn.textContent = "Sent";
    }catch(err){
      console.error("Request submit error", err);
      ui.modalError.textContent = err?.message || "Unable to send request.";
      toast("Could not send request. Check details and try again.", "error");
      ui.submitBtn.disabled = false;
      ui.submitBtn.textContent = "Send request";
    }
  }

  function handleRequestOption(type){
    const active = state.activeVehicle;
    if(!active){
      toast("Select a vehicle first.", "error");
      return;
    }
    const dealerProfile = getDealerProfile(active.dealerId);
    const whatsappDigits = sanitizeWhatsAppNumber(dealerProfile?.whatsappNumber);

    if(type === "whatsapp"){
      if(!whatsappDigits){
        toast("WhatsApp unavailable for this dealer.", "error");
        return;
      }
      openWhatsApp(active, whatsappDigits, dealerProfile);
      closeModal();
      return;
    }

    ui.reqType.value = type;
    ui.reqName.focus();
  }

  async function doLoad(){
    const dealerIds = parseDealerIds(ui.dealerIdInput.value);
    const rawIds = String(ui.dealerIdInput.value || "").trim();

    if(!rawIds){
      toast("Enter at least one dealer ID.", "error");
      return;
    }
    if(!dealerIds.length){
      toast("Dealer ID format is invalid.", "error");
      return;
    }

    state.dealerIds = dealerIds;
    setDealerInUrl(dealerIds);
    setLoading();

    try{
      const dealerId = dealerIds[0];
      const [dealerProfile, vehicleResponse] = await Promise.all([
        getDealerProfileOrLoad(dealerId),
        loadVehiclesForDealer(dealerId),
      ]);
      const vehiclesData = vehicleResponse.vehicles || [];
      const dealers = dealerProfile ? [dealerProfile] : vehicleResponse.dealer ? [vehicleResponse.dealer] : [];

      const dealerMap = new Map();
      dealerIds.forEach((dealerId) => {
        const profile = state.dealerProfiles[dealerId];
        const apiDealer = dealers.find((d) => (d.dealerId || d.dealer_id) === dealerId) || {};
        dealerMap.set(dealerId, {
          dealerId,
          dealerName: profile?.dealerName || apiDealer.dealerName || apiDealer.name || dealerId,
          status: profile?.status || apiDealer.status || "",
          logoUrl: profile?.logoUrl || apiDealer.logoUrl || apiDealer.logo || "",
          whatsappNumber: profile?.whatsappNumber || "",
          whatsappDefaultMessage: profile?.whatsappDefaultMessage || "",
        });
      });
      state.dealers = Array.from(dealerMap.values());

      const normalized = (vehiclesData || []).map(normalizeVehicle).filter(isPublicVehicle);
      state.vehicles = normalized;
      state.filtered = [...normalized];
      state.lastRefreshed = new Date().toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });

      setBranding();
      updateDealerBar();
      applySearch();
      scrollToInventory();
    }catch(e){
      console.error("Load error", e);
      state.dealers = [];
      state.vehicles = [];
      state.filtered = [];
      state.lastRefreshed = null;
      setBranding();
      updateDealerBar();
      ui.kpiLive.textContent = "0";
      renderEmptyState({
        title:"Could not load inventory",
        body:e?.message || "Unknown error",
      });
      toast("Unable to load inventory. Try again.", "error");
    }
  }

  function reset(){
    state.dealerIds = [];
    state.dealers = [];
    state.vehicles = [];
    state.filtered = [];
    state.lastRefreshed = null;

    ui.dealerIdInput.value = "";
    ui.searchInput.value = "";
    setDealerInUrl([]);
    setBranding();
    updateDealerBar();
    ui.kpiLive.textContent = "‚Äì";
    ui.kpiDealer.textContent = "‚Äì";
    render();
  }

  function rotateTip(){
    state.tipIndex = (state.tipIndex + 1) % tips.length;
    ui.rotatingTip.textContent = tips[state.tipIndex];
  }

  function scrollToInventory(){
    const inv = document.getElementById("inventory");
    if(inv){
      inv.scrollIntoView({ behavior: window.matchMedia("(prefers-reduced-motion: reduce)").matches ? "auto" : "smooth" });
    }
  }

  ui.year.textContent = new Date().getFullYear();

  ui.loadBtn.addEventListener("click", doLoad);
  ui.resetBtn.addEventListener("click", reset);
  ui.dealerIdInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") doLoad(); });
  ui.searchInput.addEventListener("input", applySearch);

  ui.scrollBtn.addEventListener("click", scrollToInventory);
  ui.heroPrimaryCta.addEventListener("click", scrollToInventory);
  ui.headerSupportBtn.addEventListener("click", ()=>{
    toast("Need help? Enter your Dealer ID or contact your dealer concierge for access.", "info");
  });

  ui.howBtn.addEventListener("click", ()=>{
    toast("Enter a Dealer ID, browse verified vehicles, then book a viewing in minutes.");
  });

  ui.modalClose.addEventListener("click", closeModal);
  ui.modalOverlay.addEventListener("click", (e)=>{ if(e.target === ui.modalOverlay) closeModal(); });
  ui.requestForm.addEventListener("submit", submitRequest);
  $$(".option-card", ui.requestOptions).forEach((btn) => {
    btn.addEventListener("click", () => {
      const type = btn.getAttribute("data-type");
      if(btn.getAttribute("data-disabled") === "true") return;
      handleRequestOption(type);
    });
  });

  (function boot(){
    const fromPath = parseDealerFromPath() || parseDealerFromQuery();
    if(fromPath){
      ui.dealerIdInput.value = fromPath;
      doLoad();
    } else {
      setBranding();
      render();
    }
    setInterval(rotateTip, 5200);
  })();
</script>

</body>
</html>
